<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chiaki æ¥µç°¡äº’å‹•çœ‹æ¿</title>
  <!-- Optional libs for image/PDF export (graceful fallback if blocked) -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root{
      --bg:#0b0c0e; --paper:#121417; --muted:#8992a3; --text:#e8eef6; --accent:#8ab4ff;
      --col-bg:#171a1f; --col-border:#262a31; --card-bg:#1d2128; --shadow:rgba(0,0,0,.5);
      --ok:#5ad27d; --warn:#ffd166; --danger:#ff6b6b; --info:#72d6ff; --violet:#c6a0ff;
    }
    .light{ /* light theme */
      --bg:#f6f7fb; --paper:#ffffff; --muted:#687080; --text:#0f172a; --accent:#2563eb;
      --col-bg:#fbfbfd; --col-border:#e6e9f2; --card-bg:#ffffff; --shadow:rgba(16,24,40,.15);
      --ok:#2fb670; --warn:#f59e0b; --danger:#ef4444; --info:#0ea5e9; --violet:#7c3aed;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.4 "Inter",system-ui,-apple-system,"Segoe UI","Noto Sans TC",sans-serif}
    *{box-sizing:border-box}

    /* é¡¶éƒ¨å·¥å…·åˆ— */
    .bar{position:sticky;top:0;z-index:20;backdrop-filter:saturate(1.2) blur(8px);background:color-mix(in oklab, var(--paper) 86%, transparent);border-bottom:1px solid var(--col-border)}
    .bar-inner{display:flex;gap:.75rem;align-items:center;max-width:1200px;margin:0 auto;padding:.75rem 1rem}
    .title[contenteditable]{outline:none;border-radius:10px;padding:.25rem .5rem}
    .title[contenteditable]:focus{box-shadow:0 0 0 2px color-mix(in oklab, var(--accent) 40%, transparent)}
    .spacer{flex:1}
    .btn{appearance:none;border:1px solid var(--col-border);background:var(--paper);color:var(--text);border-radius:10px;padding:.5rem .7rem;cursor:pointer;display:inline-flex;gap:.4rem;align-items:center;box-shadow:0 1px 0 var(--shadow)}
    .btn:hover{border-color:color-mix(in oklab, var(--accent) 50%, var(--col-border))}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:color-mix(in oklab, var(--accent) 18%, var(--paper));border-color:color-mix(in oklab, var(--accent) 40%, var(--col-border))}
    .icon{width:16px;height:16px;display:inline-block}
    input[type="file"]{display:none}

    /* çœ‹æ¿ä½ˆå±€ */
    .wrap{max-width:1200px;margin:0 auto;padding:1rem}
    .board{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem;align-items:start}

    .col{background:var(--col-bg);border:1px solid var(--col-border);border-radius:16px;min-height:220px;box-shadow:0 6px 20px var(--shadow)}
    .col-h{display:flex;gap:.5rem;align-items:center;justify-content:space-between;padding:.75rem .9rem;border-bottom:1px solid var(--col-border)}
    .col-title[contenteditable]{font-weight:700;letter-spacing:.4px;outline:none;border-radius:8px;padding:.15rem .35rem}
    .col-title[contenteditable]:focus{box-shadow:0 0 0 2px color-mix(in oklab, var(--accent) 35%, transparent)}
    .col-tools{display:flex;gap:.35rem}

    .col-body{padding:.75rem;display:flex;flex-direction:column;gap:.75rem;min-height:96px}

    .card{position:relative;background:var(--card-bg);border:1px solid var(--col-border);border-radius:14px;padding:.65rem .7rem .65rem .7rem;box-shadow:0 8px 30px var(--shadow);touch-action:none}
    .card.dragging{opacity:.85;box-shadow:0 20px 60px rgba(0,0,0,.45);transform:rotate(.5deg) scale(1.02)}
    .card .meta{display:flex;gap:.5rem;align-items:center;justify-content:space-between;margin-bottom:.35rem}
    .pill{width:12px;height:12px;border-radius:99px;border:1px solid var(--col-border)}
    .pill.ok{background:var(--ok)} .pill.warn{background:var(--warn)} .pill.danger{background:var(--danger)} .pill.info{background:var(--info)} .pill.violet{background:var(--violet)}
    .card-tools{display:flex;gap:.35rem}
    .iconbtn{background:transparent;border:1px solid var(--col-border);border-radius:8px;padding:.25rem;cursor:pointer}
    .iconbtn:hover{border-color:color-mix(in oklab, var(--accent) 45%, var(--col-border))}
    .card .text[contenteditable]{outline:none;white-space:pre-wrap}
    .card .text[contenteditable]:focus{box-shadow:0 0 0 2px color-mix(in oklab, var(--accent) 35%, transparent);border-radius:8px;padding:.15rem}

    .placeholder{border:2px dashed color-mix(in oklab, var(--accent) 65%, var(--col-border));border-radius:12px;padding:26px;opacity:.8}

    .toolbar{display:flex;gap:.35rem}

    /* å°è©±æ¡† */
    dialog{border:1px solid var(--col-border);border-radius:16px;background:var(--paper);color:var(--text);max-width:min(92vw,720px);box-shadow:0 30px 100px var(--shadow)}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    .dlg{padding:1rem}
    .dlg h3{margin:.2rem 0 1rem}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .row{display:flex;gap:.6rem;align-items:center}
    .row label{user-select:none}
    .chips{display:flex;gap:.4rem;flex-wrap:wrap}
    .chip{border:1px solid var(--col-border);padding:.25rem .5rem;border-radius:999px;cursor:pointer}
    .chip[data-on="1"]{background:color-mix(in oklab, var(--accent) 18%, var(--paper));border-color:color-mix(in oklab, var(--accent) 50%, var(--col-border))}

    /* å°æç¤º */
    .hint{font-size:12px;color:var(--muted)}

    /* éš±è—åœ¨åˆ—å°æ™‚çš„å…ƒç´  */
    @media print{
      .bar,.toolbar .btn, dialog{display:none !important}
      body{background:white}
      .wrap{max-width:100%;padding:0}
      .col{break-inside:avoid;margin:0 0 .8cm}
      .card{break-inside:avoid}
      @page{size:A4;margin:12mm}
    }
  </style>
</head>
<body class="light">
  <div class="bar">
    <div class="bar-inner">
      <div id="boardTitle" class="title" contenteditable spellcheck="false">æˆ‘çš„çœ‹æ¿</div>
      <span class="hint">ï¼ˆå¯é»æ“Šæ”¹åï¼‰</span>
      <div class="spacer"></div>
      <button class="btn primary" id="addColBtn">â• æ–°å¢æ¬„ä½</button>
      <button class="btn" id="exportBtn">â¤´ åŒ¯å‡º</button>
      <label class="btn" for="importFile">â¤µ åŒ¯å…¥</label>
      <input id="importFile" type="file" accept="application/json" />
      <button class="btn" id="printBtn">ğŸ–¨ åˆ—å° / å­˜æˆ PDF</button>
      <button class="btn" id="themeBtn">ğŸŒ— ä¸»é¡Œ</button>
      <button class="btn" id="helpBtn">â” èªªæ˜</button>
      <button class="btn" id="resetBtn">â™» é‡ç½®</button>
    </div>
  </div>

  <div class="wrap">
    <div id="board" class="board" aria-label="kanban board"></div>
  </div>

  <!-- æ–°å¢å¡ç‰‡å°è©±æ¡† -->
  <dialog id="cardDlg">
    <form method="dialog" class="dlg">
      <h3>æ–°å¢ / ç·¨è¼¯ä¾¿æ¢</h3>
      <div class="row"><label>å…§å®¹</label></div>
      <textarea id="cardText" rows="6" style="width:100%;resize:vertical;border:1px solid var(--col-border);border-radius:8px;background:var(--paper);color:var(--text);padding:.6rem"></textarea>
      <div style="height:.6rem"></div>
      <div class="row"><label>é¡è‰²</label>
        <div class="chips" id="colorChips"></div>
      </div>
      <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1rem">
        <button class="btn" value="cancel">å–æ¶ˆ</button>
        <button class="btn primary" id="saveCardBtn" value="default">å„²å­˜</button>
      </div>
    </form>
  </dialog>

  <!-- åŒ¯å‡ºå°è©±æ¡† -->
  <dialog id="exportDlg">
    <form method="dialog" class="dlg">
      <h3>åŒ¯å‡º</h3>
      <div class="grid">
        <div>
          <strong>æ ¼å¼</strong>
          <div class="row"><input type="radio" name="fmt" value="print" id="fmtPrint" checked><label for="fmtPrint">åˆ—å°ï¼ˆæˆ–å¦å­˜ PDFï¼‰</label></div>
          <div class="row"><input type="radio" name="fmt" value="png" id="fmtPng"><label for="fmtPng">PNG åœ–æª”</label></div>
          <div class="row"><input type="radio" name="fmt" value="jpeg" id="fmtJpeg"><label for="fmtJpeg">JPEG åœ–æª”</label></div>
          <div class="row"><input type="radio" name="fmt" value="pdf" id="fmtPdf"><label for="fmtPdf">PDF æª”</label></div>
          <div class="row"><input type="radio" name="fmt" value="json" id="fmtJson"><label for="fmtJson">JSONï¼ˆè³‡æ–™å‚™ä»½ï¼åˆ†äº«ï¼‰</label></div>
        </div>
        <div>
          <strong>ç¯„åœ</strong>
          <div class="row"><input type="radio" name="range" value="all" id="rngAll" checked><label for="rngAll">æ•´å€‹çœ‹æ¿</label></div>
          <div class="row"><input type="radio" name="range" value="visible" id="rngVisible"><label for="rngVisible">ç›®å‰å¯è¦‹ç¯„åœ</label></div>
          <div class="row"><input type="radio" name="range" value="cols" id="rngCols"><label for="rngCols">æŒ‡å®šæ¬„ä½</label></div>
          <div id="colPick" class="chips" style="margin-top:.4rem"></div>
          <div style="height:.4rem"></div>
          <div class="row"><label for="scale">è§£æåº¦å€ç‡ï¼ˆåœ–æª”/PDFï¼‰ï¼š</label><input id="scale" type="number" min="1" max="3" step="1" value="2" style="width:64px"></div>
          <div class="row"><input type="checkbox" id="showHeader" checked><label for="showHeader">é¡¯ç¤ºæŠ¬é ­ï¼ˆæ¨™é¡Œ/æ—¥æœŸï¼‰</label></div>
        </div>
      </div>
      <div class="hint" id="exportHint" style="margin-top:.5rem">æç¤ºï¼šè‹¥åœ–æª”/PDF å¤±æ•—ï¼Œè«‹æ”¹ç”¨ã€Œåˆ—å°ã€ä¸¦åœ¨ç€è¦½å™¨é¸æ“‡ã€Œå¦å­˜ç‚º PDFã€ã€‚</div>
      <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1rem">
        <button class="btn" value="cancel">å–æ¶ˆ</button>
        <button class="btn primary" id="doExport" value="default">é–‹å§‹åŒ¯å‡º</button>
      </div>
    </form>
  </dialog>

  <!-- èªªæ˜å°è©±æ¡† -->
  <dialog id="helpDlg">
    <div class="dlg">
      <h3>ä½¿ç”¨èªªæ˜</h3>
      <ul>
        <li>é»ä¸Šæ–¹ã€Œæˆ‘çš„çœ‹æ¿ã€å¯æ”¹åï¼›æ¯å€‹æ¬„ä½åç¨±ä¹Ÿå¯ç›´æ¥é»æ“Šç·¨è¼¯ã€‚</li>
        <li>ã€Œæ–°å¢æ¬„ä½ã€å¯å»ºç«‹æ›´å¤šåˆ†æ¬„ï¼›æ¯æ¬„å³ä¸Šè§’ã€Œï¼‹ã€æ–°å¢ä¾¿æ¢ï¼Œã€ŒğŸ—‘ã€åˆªé™¤æ­¤æ¬„ã€‚</li>
        <li>æ‹–æ›³ä¾¿æ¢å³å¯ç§»å‹•ï¼ˆæ‰‹æ©Ÿä¹Ÿæ”¯æ´ï¼‰ï¼›é»æ–‡å­—å¯ç›´æ¥ç·¨è¼¯ã€‚</li>
        <li>æ‰€æœ‰è®Šæ›´æœƒè‡ªå‹•å„²å­˜æ–¼æœ¬æ©Ÿï¼ˆLocalStorageï¼‰ã€‚å¯ç”¨ã€ŒåŒ¯å‡º JSONã€å‚™ä»½ï¼åˆ†äº«ï¼Œä¸¦ç”¨ã€ŒåŒ¯å…¥ã€é‚„åŸã€‚</li>
        <li>åŒ¯å‡ºåœ–æª”ï¼PDF éœ€å¤–éƒ¨ç¨‹å¼åº«ï¼ˆå·²è‡ªå‹•è¼‰å…¥ï¼‰ã€‚è‹¥åœ¨æ‚¨çš„ç’°å¢ƒè¢«å°é–ï¼Œè«‹ä½¿ç”¨ã€Œåˆ—å° â†’ å¦å­˜ PDFã€ã€‚</li>
      </ul>
      <div style="text-align:right;margin-top:.5rem"><button class="btn" onclick="helpDlg.close()">å¥½çš„</button></div>
    </div>
  </dialog>

  <script>
  const $ = (sel, root=document)=>root.querySelector(sel);
  const $$ = (sel, root=document)=>Array.from(root.querySelectorAll(sel));

  // --- State ---
  const STORE_KEY = 'chiaki_kanban_v1';
  let state = {
    title: 'æˆ‘çš„çœ‹æ¿',
    theme: 'light',
    cols: [
      {id: uid(), title:'å¾…è¾¦', cards:[{id:uid(), text:'ç¯„ä¾‹ï¼šæº–å‚™é–‹å­¸ç‰©è³‡', color:'info'}]},
      {id: uid(), title:'é€²è¡Œä¸­', cards:[{id:uid(), text:'ç¯„ä¾‹ï¼šé€±æœƒç°¡å ±ï¼ˆæ ¡å‹™ï¼‰', color:'violet'}]},
      {id: uid(), title:'å·²å®Œæˆ', cards:[{id:uid(), text:'ç¯„ä¾‹ï¼šå°è­·å€¼å‹¤è¡¨', color:'ok'}]},
    ]
  };

  function uid(){return Math.random().toString(36).slice(2,9)}
  function save(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); refreshColPick(); }
  function load(){ try{ const raw = localStorage.getItem(STORE_KEY); if(raw){ state = JSON.parse(raw); } }catch(e){ console.warn('load fail',e) }
    document.body.classList.toggle('light', state.theme==='light');
  }

  // --- Render ---
  const board = $('#board');
  function render(){
    $('#boardTitle').textContent = state.title;
    board.innerHTML = '';
    for(const col of state.cols){
      board.appendChild(renderCol(col));
    }
  }

  function renderCol(col){
    const el = document.createElement('section'); el.className='col'; el.dataset.id = col.id;
    el.innerHTML = `
      <div class="col-h">
        <div class="col-title" contenteditable spellcheck="false">${escapeHtml(col.title)}</div>
        <div class="col-tools">
          <button class="iconbtn" data-act="add" title="æ–°å¢ä¾¿æ¢">ï¼‹</button>
          <button class="iconbtn" data-act="del" title="åˆªé™¤æ­¤æ¬„">ğŸ—‘</button>
        </div>
      </div>
      <div class="col-body" aria-label="column body"></div>
    `;
    const body = $('.col-body', el);
    for(const card of col.cards){ body.appendChild(renderCard(card)); }

    const title = $('.col-title', el);
    title.addEventListener('blur', () => { col.title = title.textContent.trim()||'æœªå‘½å'; save(); refreshTitleInExport(); });

    const addBtn = $('.col-tools [data-act="add"]', el);
    const delBtn = $('.col-tools [data-act="del"]', el);
    addBtn.addEventListener('pointerdown', ev=> ev.stopPropagation());
    delBtn.addEventListener('pointerdown', ev=> ev.stopPropagation());
    addBtn.addEventListener('click', (ev)=> { ev.stopPropagation(); openCardDialog(col.id); });
    delBtn.addEventListener('click', (ev)=> { ev.stopPropagation(); if(confirm('ç¢ºå®šåˆªé™¤æ­¤æ¬„ï¼Ÿå…¶ä¸­çš„ä¾¿æ¢ä¹Ÿæœƒåˆªé™¤ã€‚')){ state.cols = state.cols.filter(c=>c.id!==col.id); save(); render(); }});

    enableDropFor(body);
    return el;
  }

  function renderCard(card){
    const el = document.createElement('article'); el.className='card'; el.dataset.id = card.id;
    el.innerHTML = `
      <div class="meta">
        <span class="pill ${card.color||'info'}"></span>
        <div class="card-tools">
          <button class="iconbtn" data-act="edit" title="ç·¨è¼¯">âœï¸</button>
          <button class="iconbtn" data-act="del" title="åˆªé™¤">ğŸ—‘</button>
        </div>
      </div>
      <div class="text" contenteditable spellcheck="true">${escapeHtml(card.text)}</div>
    `;

    const text = $('.text', el);
    text.addEventListener('blur', ()=> { card.text = text.textContent.trim(); save(); });

    const editBtn = $('.card-tools [data-act="edit"]', el);
    const delBtn = $('.card-tools [data-act="del"]', el);
    [editBtn, delBtn].forEach(b=>{
      b.addEventListener('pointerdown', ev=> ev.stopPropagation());
      b.addEventListener('click', ev=> ev.stopPropagation());
    });
    editBtn.addEventListener('click', ()=> openCardDialog(null, card));
    delBtn.addEventListener('click', ()=> { if(confirm('åˆªé™¤é€™å¼µä¾¿æ¢ï¼Ÿ')){ removeCard(card.id); }});

    enableDrag(el);
    return el;
  }

  function removeCard(cardId){
    for(const col of state.cols){
      const idx = col.cards.findIndex(c=>c.id===cardId);
      if(idx>-1){ col.cards.splice(idx,1); break; }
    }
    save(); render();
  }

  // --- Drag & drop (pointer events, mobile friendly) ---
  let dragging = null, dragData = null, placeholder = null;

  // SAFETY: avoid hierarchy errors when placing placeholder
  function safePlacePlaceholder(colBody, beforeNode){
    if(!colBody || !placeholder) return;
    if(colBody === placeholder) return;
    if(placeholder.contains(colBody)) return; // é˜²æ­¢æŠŠç¥–å…ˆå¡åˆ°å­å­«
    // è‹¥ beforeNode ä¸å±¬æ–¼ colBodyï¼Œå¿½ç•¥
    if(beforeNode && beforeNode.parentElement !== colBody) beforeNode = null;
    if(beforeNode){
      if(beforeNode !== placeholder) colBody.insertBefore(placeholder, beforeNode);
    } else {
      if(placeholder.parentElement !== colBody || placeholder.nextElementSibling){
        colBody.appendChild(placeholder);
      }
    }
  }

  function enableDrag(cardEl){
    let dragArmed=false, startX=0, startY=0;
    cardEl.addEventListener('pointerdown', (e)=>{
      if(e.button!==0) return;
      // è‹¥é»åœ¨æŒ‰éˆ•æˆ–å¯ç·¨è¼¯æ–‡å­—ï¼Œä¸å•Ÿå‹•æ‹–æ›³
      if(e.target.closest('.iconbtn') || e.target.closest('.text')) return;
      dragArmed = true; startX=e.clientX; startY=e.clientY;
    });

    cardEl.addEventListener('pointermove', (e)=>{
      if(!(dragArmed || dragging)) return;
      if(!dragging){
        const moved = Math.hypot(e.clientX-startX, e.clientY-startY);
        if(moved < 5) return; // å•Ÿå‹•é–¾å€¼ï¼Œé¿å…èª¤è§¸
        dragging = cardEl; dragging.classList.add('dragging');
        placeholder = document.createElement('div'); placeholder.className='placeholder'; placeholder.textContent='æ”¾é€™è£¡';
        const srcBody = cardEl.parentElement; if(srcBody){ srcBody.insertBefore(placeholder, cardEl.nextSibling); }
        dragData = {
          srcCol: cardEl.closest('.col'),
          cardId: cardEl.dataset.id,
          shiftX: e.clientX - cardEl.getBoundingClientRect().left,
          shiftY: e.clientY - cardEl.getBoundingClientRect().top
        };
        // è®“ä¸‹å±¤å…ƒç´ å¯è¢«å‘½ä¸­ï¼ˆåŒ…å«ç©ºæ¬„ï¼‰
        cardEl.setPointerCapture(e.pointerId);
        cardEl.style.pointerEvents='none';
        cardEl.style.position='fixed'; cardEl.style.width = cardEl.getBoundingClientRect().width+'px';
      }
      moveAt(e.clientX, e.clientY); updateDropTarget(e.clientX, e.clientY);
    });

    const endDrag = ()=>{ dragArmed=false; if(!dragging) return; dropAt(); };
    cardEl.addEventListener('pointerup', endDrag);
    cardEl.addEventListener('pointercancel', endDrag);
  }

  function moveAt(x,y){ if(dragging){ dragging.style.left=(x - dragData.shiftX)+'px'; dragging.style.top=(y - dragData.shiftY)+'px'; } }

  function getColBodyFromPoint(x,y){
    const el = document.elementFromPoint(x,y);
    if(!el) return null;
    const viaClosest = el.closest ? el.closest('.col-body') : null;
    if(viaClosest) return viaClosest;
    if(el.classList && el.classList.contains('col-body')) return el;
    return null;
  }

  function updateDropTarget(x,y){
    const colBody = getColBodyFromPoint(x,y);
    if(!colBody) return;
    // è¨ˆç®—æ’å…¥ä½ç½®
    const cards = $$('.card', colBody).filter(c=>c!==dragging);
    let placed=false;
    for(const c of cards){
      const r = c.getBoundingClientRect();
      if(y < r.top + r.height/2){ safePlacePlaceholder(colBody, c); placed=true; break; }
    }
    if(!placed){ safePlacePlaceholder(colBody, null); }
  }

  function dropAt(){
    dragging.classList.remove('dragging');
    dragging.style.pointerEvents='';
    dragging.style.position=''; dragging.style.left=''; dragging.style.top=''; dragging.style.width='';

    const targetColBody = placeholder?.parentElement;
    const fromCol = dragData.srcCol; const toCol = targetColBody?.closest('.col');
    const cardId = dragData.cardId;

    if(targetColBody && toCol){
      let src = state.cols.find(c=>c.id===fromCol.dataset.id);
      let dst = state.cols.find(c=>c.id===toCol.dataset.id);
      const card = src.cards.find(c=>c.id===cardId);
      // å¾ä¾†æºç§»é™¤
      src.cards = src.cards.filter(c=>c.id!==cardId);
      // ç›®æ¨™æ’å…¥ç´¢å¼•ï¼ˆä¾ placeholder çš„ä½ç½®ï¼‰
      let idx = Array.from(targetColBody.children).indexOf(placeholder);
      if(idx < 0) idx = targetColBody.children.length;
      dst.cards.splice(idx,0,card);
    }
    placeholder?.remove(); placeholder=null; dragging=null; dragData=null; save(); render();
  }

  function enableDropFor(colBody){ /* placeholder driven; nothing else needed */ }

  // --- Card dialog (create/edit) ---
  const cardDlg = $('#cardDlg');
  const cardText = $('#cardText');
  const colorChips = $('#colorChips');
  const palette = ['ok','warn','danger','info','violet'];
  let editing = { colId: null, card: null };

  function openCardDialog(colId, card){
    editing.colId = colId; editing.card = card||null;
    cardText.value = card? card.text: '';
    colorChips.innerHTML='';
    for(const c of palette){
      const chip = document.createElement('button'); chip.type='button'; chip.className='chip'; chip.dataset.color=c; chip.textContent=c;
      if(card?.color===c) chip.dataset.on='1';
      chip.addEventListener('click',()=>{
        $$('.chip', colorChips).forEach(x=>x.dataset.on='0'); chip.dataset.on='1';
      });
      colorChips.appendChild(chip);
    }
    cardDlg.showModal();
  }
  $('#saveCardBtn').addEventListener('click', (e)=>{
    e.preventDefault();
    const pick = $$('.chip', colorChips).find(x=>x.dataset.on==='1');
    const color = pick? pick.dataset.color: 'info';
    const text = cardText.value.trim(); if(!text){ alert('è«‹è¼¸å…¥å…§å®¹'); return; }
    if(editing.card){ editing.card.text=text; editing.card.color=color; }
    else{
      const col = state.cols.find(c=>c.id===editing.colId); col.cards.push({id:uid(), text, color});
    }
    cardDlg.close(); save(); render();
  });

  // --- Export / Import / Print ---
  const exportDlg = $('#exportDlg');
  $('#exportBtn').addEventListener('click', ()=>{ refreshColPick(); exportDlg.showModal(); });
  $('#printBtn').addEventListener('click', ()=> window.print());
  $('#helpBtn').addEventListener('click', ()=> $('#helpDlg').showModal());

  function refreshTitleInExport(){ $('#boardTitle').textContent = state.title; }

  function refreshColPick(){
    const colPick = $('#colPick'); colPick.innerHTML='';
    for(const col of state.cols){
      const chip = document.createElement('label'); chip.className='chip'; chip.dataset.id = col.id; chip.textContent = col.title;
      chip.addEventListener('click', ()=>{ chip.dataset.on = chip.dataset.on==='1'?'0':'1'; });
      colPick.appendChild(chip);
    }
  }

  $('#doExport').addEventListener('click', async (e)=>{
    e.preventDefault();
    const fmt = document.querySelector('input[name="fmt"]:checked').value;
    if(fmt==='json'){ download(JSON.stringify(state, null, 2), safeName(state.title)+'.json', 'application/json'); exportDlg.close(); return; }
    if(fmt==='print'){ exportDlg.close(); window.print(); return; }

    // capture target
    const rng = document.querySelector('input[name="range"]:checked').value;
    const scale = parseInt($('#scale').value||'2',10);
    const showHeader = $('#showHeader').checked;

    const target = buildSnapshotTarget(rng, showHeader);
    if(!target){ return; }
    try{
      if(!window.html2canvas){ alert('åŒ¯å‡ºåœ–æª”/PDF éœ€è¦ html2canvasï¼Œæ‚¨çš„ç’°å¢ƒä¼¼ä¹å°é–å¤–éƒ¨ç¨‹å¼åº«ã€‚è«‹æ”¹ç”¨ã€Œåˆ—å° â†’ å¦å­˜ PDFã€ã€‚'); return; }
      const canvas = await html2canvas(target, {scale: scale, backgroundColor: getComputedStyle(document.body).backgroundColor});
      if(fmt==='png' || fmt==='jpeg'){
        const mime = fmt==='png' ? 'image/png' : 'image/jpeg';
        const data = canvas.toDataURL(mime, fmt==='jpeg'? .92: 1.0);
        download(data, safeName(state.title)+'.'+fmt);
      } else if(fmt==='pdf'){
        if(!window.jspdf){ alert('PDF åŒ¯å‡ºéœ€è¦ jsPDFï¼Œè«‹æ”¹ç”¨åˆ—å°æˆ–ç¢ºèªç¶²è·¯å…è¨±è¼‰å…¥å¤–éƒ¨ç¨‹å¼åº«ã€‚'); return; }
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({orientation: 'p', unit:'pt', format:'a4'});
        const pageW = pdf.internal.pageSize.getWidth();
        const pageH = pdf.internal.pageSize.getHeight();
        const imgW = pageW; const imgH = canvas.height * (imgW / canvas.width);
        let y = 0; let page = 0; const img = canvas.toDataURL('image/jpeg', .92);
        while(y < imgH){
          if(page>0) pdf.addPage();
          pdf.addImage(img, 'JPEG', 0, -y, imgW, imgH);
          y += pageH; page++;
        }
        pdf.save(safeName(state.title)+'.pdf');
      }
    } finally {
      target.remove(); exportDlg.close();
    }
  });

  function buildSnapshotTarget(rng, showHeader){
    // Make a clean snapshot node detached from layout for stable capture
    const snap = document.createElement('div');
    snap.style.position='fixed'; snap.style.left='-99999px'; snap.style.top='-99999px';
    snap.style.width = document.querySelector('.wrap').offsetWidth + 'px';
    snap.style.padding='1rem'; snap.style.background = getComputedStyle(document.body).backgroundColor;

    if(showHeader){
      const header = document.createElement('div'); header.style.margin='0 0 8px'; header.style.display='flex'; header.style.justifyContent='space-between';
      header.innerHTML = `<div style="font-weight:700;font-size:20px">${escapeHtml(state.title)}</div><div style="color:${getComputedStyle(document.querySelector('.hint')).color};font-size:12px">${new Date().toLocaleString()}</div>`;
      snap.appendChild(header);
    }

    const grid = document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns = getComputedStyle(board).gridTemplateColumns; grid.style.gap='1rem';
    snap.appendChild(grid);

    let cols = [];
    if(rng==='all'){ cols = state.cols; }
    else if(rng==='visible'){ cols = state.cols; }
    else if(rng==='cols'){
      const ids = $$('#colPick .chip[data-on="1"]').map(x=>x.dataset.id);
      cols = state.cols.filter(c=>ids.includes(c.id));
      if(cols.length===0){ alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ¬„ä½'); return null; }
    }

    for(const col of cols){
      const c = document.createElement('section'); c.style.border='1px solid '+getVar('--col-border'); c.style.background=getVar('--col-bg'); c.style.borderRadius='16px'; c.style.padding='10px';
      const h = document.createElement('div'); h.style.fontWeight='700'; h.style.margin='4px 6px 10px'; h.textContent = col.title; c.appendChild(h);
      for(const card of col.cards){
        const k = document.createElement('div'); k.style.border='1px solid '+getVar('--col-border'); k.style.background=getVar('--card-bg'); k.style.borderRadius='12px'; k.style.padding='8px 10px'; k.style.margin='0 0 10px';
        const meta = document.createElement('div'); meta.style.display='flex'; meta.style.justifyContent='space-between'; meta.style.alignItems='center'; meta.style.margin='0 0 6px';
        const dot = document.createElement('span'); dot.style.width='10px'; dot.style.height='10px'; dot.style.borderRadius='999px'; dot.style.display='inline-block'; dot.style.border='1px solid '+getVar('--col-border');
        dot.style.background = getColor(card.color);
        meta.appendChild(dot); k.appendChild(meta);
        const t = document.createElement('div'); t.style.whiteSpace='pre-wrap'; t.textContent = card.text; k.appendChild(t);
        c.appendChild(k);
      }
      grid.appendChild(c);
    }

    document.body.appendChild(snap);
    return snap;
  }

  function getVar(name){ return getComputedStyle(document.body).getPropertyValue(name).trim(); }
  function getColor(kind){
    switch(kind){ case 'ok': return getVar('--ok'); case 'warn': return getVar('--warn'); case 'danger': return getVar('--danger'); case 'info': return getVar('--info'); case 'violet': return getVar('--violet'); default: return getVar('--info'); }
  }

  function download(dataUrlOrText, name, mime){
    if(typeof dataUrlOrText === 'string' && dataUrlOrText.startsWith('data:')){ const a=document.createElement('a'); a.href=dataUrlOrText; a.download=name; a.click(); return; }
    const blob = new Blob([dataUrlOrText], {type: mime || 'application/octet-stream'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }
  function safeName(s){ return s.replace(/[\\/:*?"<>|]/g,'_'); }
  function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

  // --- Import ---
  $('#importFile').addEventListener('change', async (e)=>{
    const f = e.target.files[0]; if(!f) return; const text = await f.text();
    try{ const data = JSON.parse(text); if(!data.cols) throw new Error('æ ¼å¼ä¸ç¬¦'); state = data; save(); render(); } catch(err){ alert('åŒ¯å…¥å¤±æ•—ï¼š' + err.message); }
    e.target.value='';
  });

  // --- Title / theme / reset ---
  $('#boardTitle').addEventListener('blur', ()=>{ state.title = $('#boardTitle').textContent.trim()||'æœªå‘½å'; save(); });
  $('#themeBtn').addEventListener('click', ()=>{ state.theme = (state.theme==='light')? 'dark':'light'; document.body.classList.toggle('light', state.theme==='light'); save(); });
  $('#resetBtn').addEventListener('click', ()=>{ if(confirm('é‡ç½®æœƒåˆªé™¤æœ¬æ©Ÿå„²å­˜çš„çœ‹æ¿è³‡æ–™ï¼Œç¢ºå®šå—ï¼Ÿ')){ localStorage.removeItem(STORE_KEY); location.reload(); }});

  // --- Add column ---
  $('#addColBtn').addEventListener('click', ()=>{
    const name = prompt('æ–°æ¬„ä½åç¨±', 'æ–°æ¬„ä½'); if(!name) return; state.cols.push({id:uid(), title:name.trim(), cards:[]}); save(); render();
  });

  // --- Self tests (é–‹å•Ÿ #test æœƒè‡ªå‹•è·‘) ---
  function runSelfTests(){
    const logs = [];
    // Test 1: safePlacePlaceholder ä¸æ‡‰æ‹‹ HierarchyRequestError
    try{
      const temp = document.createElement('div');
      const fakeBody = document.createElement('div'); fakeBody.className='col-body'; temp.appendChild(fakeBody);
      placeholder = document.createElement('div'); placeholder.className='placeholder'; fakeBody.appendChild(placeholder);
      // å˜—è©¦æŠŠ placeholder æ’åˆ°è‡ªèº«ç¥–å…ˆï¼ˆæ‡‰è¢«å¿½ç•¥ï¼Œä¸æ‹‹éŒ¯ï¼‰
      safePlacePlaceholder(placeholder, null);
      logs.push('Test1 âœ… no error');
    }catch(e){ logs.push('Test1 âŒ '+e.message); }

    // Test 2: insertBefore é‚è¼¯åœ¨åˆæ³•ç¯€é»ä¸Šå¯é‹ä½œ
    try{
      const fake = document.createElement('div'); fake.className='col-body';
      placeholder = document.createElement('div'); placeholder.className='placeholder'; fake.appendChild(placeholder);
      const b = document.createElement('div'); b.className='card'; fake.appendChild(b);
      safePlacePlaceholder(fake, b);
      logs.push('Test2 âœ… insertBefore works');
    }catch(e){ logs.push('Test2 âŒ '+e.message); }

    console.log('[Kanban self-tests]', ...logs);
    alert('Self-tests finished:\n'+logs.join('\n'));
  }

  // Init
  load(); render(); refreshColPick();
  if(location.hash==='#test'){ setTimeout(runSelfTests, 0); }

  </script>
</body>
</html>
