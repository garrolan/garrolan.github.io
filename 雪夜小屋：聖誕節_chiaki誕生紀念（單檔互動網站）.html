<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>é›ªå¤œå°å±‹ï¼šè–èª•ç¯€ Ã— Chiakièª•ç”Ÿç´€å¿µ</title>
  <style>
    :root{
      --bg0:#070a10;
      --bg1:#0b1220;
      --card:#0f1a2c;
      --card2:#0c1626;
      --line:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65);
      --warm:#ffd27a;
      --mint:#7fe3c2;
      --pine:#62b59b;
      --danger:#ff7a7a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r: 18px;
      --r2: 28px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", Arial;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background: radial-gradient(1200px 900px at 30% 10%, rgba(100,140,255,.12), transparent 60%),
                  radial-gradient(1000px 600px at 70% 30%, rgba(255,210,122,.12), transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow-x:hidden;
    }

    a{ color:inherit; }

    .wrap{ min-height:100%; display:flex; flex-direction:column; }

    /* Snow */
    .snow{
      position:fixed; inset:0; pointer-events:none; z-index:1;
      opacity:.55;
    }
    .snow.off{ display:none; }
    .flake{
      position:absolute;
      width:6px; height:6px;
      border-radius:999px;
      background: rgba(255,255,255,.85);
      filter: blur(.2px);
      animation: fall linear infinite;
      opacity:.85;
    }
    @keyframes fall{
      0%{ transform: translateY(-20px) translateX(0); opacity:0; }
      10%{ opacity:.85; }
      100%{ transform: translateY(105vh) translateX(40px); opacity:0; }
    }

    /* Layout */
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(7,10,16,.72), rgba(7,10,16,.35));
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .topbar{
      max-width:1100px; margin:0 auto;
      padding:14px 16px;
      display:flex; align-items:center; gap:12px;
    }
    .brand{
      display:flex; flex-direction:column;
      gap:2px;
    }
    .brand .t{ font-weight:700; letter-spacing:.5px; }
    .brand .s{ font-size:12px; color:var(--muted); }

    .pill{
      margin-left:auto;
      display:flex; align-items:center; gap:10px;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;
      background: rgba(255,255,255,.06);
    }
    .chip{
      font-size:12px; color:var(--muted);
      display:flex; align-items:center; gap:6px;
    }
    .dot{ width:7px; height:7px; border-radius:999px; background: rgba(255,255,255,.35); }
    .dot.warm{ background: rgba(255,210,122,.8); }
    .dot.mint{ background: rgba(127,227,194,.85); }

    main{ position:relative; z-index:2; }
    .container{ max-width:1100px; margin:0 auto; padding:18px 16px 56px; }

    .view{ display:none; }
    .view.active{ display:block; }

    /* Cards */
    .card{
      background: linear-gradient(180deg, rgba(15,26,44,.88), rgba(12,22,38,.88));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
    }
    .card.pad{ padding:18px; }

    .grid{ display:grid; gap:14px; }
    .grid.cols2{ grid-template-columns: 1.1fr .9fr; }
    .grid.cols3{ grid-template-columns: repeat(3, 1fr); }
    @media (max-width:900px){
      .grid.cols2{ grid-template-columns: 1fr; }
      .grid.cols3{ grid-template-columns: 1fr; }
      .pill{ display:none; }
    }

    .btn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      font-weight:600;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.22); }
    .btn:active{ transform: translateY(0px); }
    .btn.primary{
      background: rgba(255,210,122,.13);
      border-color: rgba(255,210,122,.35);
    }
    .btn.danger{
      background: rgba(255,122,122,.10);
      border-color: rgba(255,122,122,.35);
    }
    .btn.small{ padding:8px 10px; border-radius: 12px; font-weight:600; font-size:13px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .muted{ color: var(--muted); }
    .sep{ height:1px; background: rgba(255,255,255,.10); margin:14px 0; }

    /* Landing */
    .hero{
      padding:22px;
      position:relative;
      overflow:hidden;
    }
    .hero:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(900px 500px at 20% 20%, rgba(255,210,122,.22), transparent 60%),
                  radial-gradient(900px 500px at 70% 35%, rgba(127,227,194,.18), transparent 55%),
                  radial-gradient(800px 500px at 40% 80%, rgba(110,150,255,.10), transparent 60%);
      filter: blur(0px);
      z-index:0;
    }
    .hero > *{ position:relative; z-index:1; }

    h1{ margin:0 0 8px; font-size:28px; letter-spacing:.4px; }
    h2{ margin:0 0 10px; font-size:20px; }
    p{ margin:0 0 10px; line-height:1.6; }

    /* Hub */
    .hub{
      padding:18px;
    }
    .scene{
      position:relative;
      min-height:420px;
      border-radius: var(--r2);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(10,18,32,.85), rgba(6,10,16,.90));
    }
    .scene:before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(900px 420px at 40% 25%, rgba(255,210,122,.10), transparent 60%),
        radial-gradient(700px 380px at 75% 40%, rgba(127,227,194,.08), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.03), transparent 30%);
      opacity:1;
    }
    .scene > *{ position:relative; z-index:2; }

    .hintbar{
      position:absolute; left:16px; top:14px;
      display:flex; gap:10px; flex-wrap:wrap;
      z-index:5;
    }
    .badge{
      font-size:12px; padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color: var(--muted);
    }

    .obj{
      position:absolute;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      box-shadow: 0 18px 35px rgba(0,0,0,.35);
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .obj:hover{ transform: translateY(-2px); background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.22); }

    .tree{
      left: calc(50% - 120px);
      top: 70px;
      width: 240px;
      height: 300px;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
      justify-content:flex-start;
    }
    .tree .title{ font-weight:800; letter-spacing:.4px; }
    .tree .sub{ font-size:12px; color: var(--muted); }
    .treeCanvas{
      position:relative;
      width: 100%;
      height: 225px;
      border-radius:18px;
      background:
        radial-gradient(200px 140px at 50% 15%, rgba(255,210,122,.12), transparent 60%),
        radial-gradient(220px 160px at 40% 30%, rgba(127,227,194,.08), transparent 65%),
        linear-gradient(180deg, rgba(98,181,155,.08), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
    }
    .treeShape{
      position:absolute;
      left:50%; transform: translateX(-50%);
      bottom: 14px;
      width: 0; height: 0;
      border-left: 90px solid transparent;
      border-right: 90px solid transparent;
      border-bottom: 190px solid rgba(98,181,155,.25);
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.25));
    }
    .trunk{
      position:absolute;
      left:50%; transform: translateX(-50%);
      bottom: 6px;
      width: 32px; height: 32px;
      border-radius:10px;
      background: rgba(255,210,122,.14);
      border: 1px solid rgba(255,210,122,.22);
    }
    .starTop{
      position:absolute;
      left:50%; transform: translateX(-50%);
      top: 6px;
      font-size:18px;
      opacity:.85;
      filter: drop-shadow(0 8px 12px rgba(0,0,0,.25));
    }

    .orn{
      position:absolute;
      width: 14px; height: 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.10);
      box-shadow: 0 10px 18px rgba(0,0,0,.35);
    }
    .orn:hover{ transform: scale(1.08); }

    .fireplace{
      left: 60px;
      top: 145px;
      width: 250px;
      height: 180px;
      padding:14px;
      display:flex; flex-direction:column; gap:8px;
    }
    .fire{
      margin-top:auto;
      width:100%;
      height:62px;
      border-radius:16px;
      background: radial-gradient(60px 40px at 35% 65%, rgba(255,210,122,.35), transparent 70%),
                  radial-gradient(70px 45px at 55% 75%, rgba(255,170,80,.25), transparent 70%),
                  radial-gradient(60px 40px at 68% 65%, rgba(255,210,122,.28), transparent 70%),
                  linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.00));
      border:1px solid rgba(255,255,255,.08);
      position:relative;
      overflow:hidden;
    }
    .fire:after{
      content:"";
      position:absolute; inset:-30px;
      background: radial-gradient(140px 80px at 45% 70%, rgba(255,210,122,.22), transparent 65%);
      animation: flicker 2.8s ease-in-out infinite;
    }
    @keyframes flicker{
      0%,100%{ transform: translateY(4px); opacity:.65; }
      50%{ transform: translateY(-2px); opacity:.95; }
    }

    .gifts{
      right: 60px;
      top: 165px;
      width: 250px;
      height: 160px;
      padding:14px;
      display:flex; flex-direction:column; gap:8px;
    }
    .giftStack{
      margin-top:auto;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:8px;
    }
    .gift{
      height: 34px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      position:relative;
      overflow:hidden;
    }
    .gift:before{
      content:"";
      position:absolute; left:50%; top:-8px;
      width: 10px; height: 52px;
      transform: translateX(-50%);
      background: rgba(255,210,122,.18);
    }
    .gift:after{
      content:"";
      position:absolute; left:0; top:50%;
      width: 100%; height: 8px;
      transform: translateY(-50%);
      background: rgba(127,227,194,.12);
    }

    .desk{
      left: calc(50% - 110px);
      bottom: 20px;
      width: 220px;
      height: 78px;
      padding:12px;
      display:flex; flex-direction:column; gap:6px;
    }

    /* Game shells */
    .shell{
      padding:18px;
    }
    .shell .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom:12px;
    }
    .shell .top .meta{ display:flex; flex-direction:column; gap:4px; }
    .shell .top .meta .k{ font-weight:800; }
    .shell .top .meta .d{ font-size:12px; color: var(--muted); }

    .panel{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      padding:14px;
    }

    /* Decorator */
    .pickGrid{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px; }
    @media (max-width:700px){ .pickGrid{ grid-template-columns:1fr; } }

    select, input[type="text"], textarea{
      width:100%;
      padding:10px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
    }
    textarea{ min-height:96px; resize:vertical; }

    .preview{
      display:flex; align-items:center; gap:12px;
      padding:12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .token{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--muted);
    }

    /* Memory Match */
    .mmGrid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width:800px){ .mmGrid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
    .mmCard{
      height: 82px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      user-select:none;
      font-size: 22px;
      position:relative;
      transition: transform .10s ease, background .12s ease;
    }
    .mmCard:hover{ transform: translateY(-1px); background: rgba(255,255,255,.07); }
    .mmCard.matched{ opacity:.75; filter:saturate(.9); }
    .mmBack{ font-size:12px; color: rgba(255,255,255,.55); }

    /* Typing */
    .typeArea{ position:relative; height: 280px; overflow:hidden; border-radius: 18px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.03); }
    .drop{
      position:absolute;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      font-size:13px;
      color: rgba(255,255,255,.85);
      display:flex; align-items:center; gap:8px;
      box-shadow: 0 10px 18px rgba(0,0,0,.30);
    }
    .drop .mini{ font-size:16px; opacity:.9; }

    /* Story */
    .storyCard{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding:12px;
    }
    .storyCard .cap{ font-size:12px; color: var(--muted); margin-bottom:6px; }
    .storyCard .txt{ line-height:1.65; white-space:pre-wrap; }

    /* Toast */
    .toast{
      position:fixed;
      left:50%; bottom:18px;
      transform: translateX(-50%);
      padding:10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.18);
      color: rgba(255,255,255,.92);
      box-shadow: var(--shadow);
      z-index: 50;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      max-width: 92vw;
    }
    .toast.show{ opacity:1; }

    footer{
      position:relative;
      z-index:2;
      margin-top:auto;
      padding:14px 16px 18px;
      color: rgba(255,255,255,.55);
      font-size:12px;
      text-align:center;
    }

    /* Reduced motion */
    .reduced *{ animation:none !important; transition:none !important; }
  </style>
</head>
<body>
  <div class="snow" id="snow"></div>

  <div class="wrap" id="app">
    <header>
      <div class="topbar">
        <div class="brand">
          <div class="t">é›ªå¤œå°å±‹</div>
          <div class="s">è–èª•ç¯€ Ã— Chiaki èª•ç”Ÿç´€å¿µ Ã— æˆ‘å€‘çš„å°å®‡å®™</div>
        </div>
        <div class="pill" aria-label="ç‹€æ…‹">
          <div class="chip"><span class="dot warm"></span> æ˜Ÿæ˜Ÿ <b id="stars">0</b></div>
          <div class="chip"><span class="dot mint"></span> æ›é£¾ <b id="ornCount">0</b></div>
          <div class="chip"><span class="dot"></span> ç¥ç¦ç¢ç‰‡ <b id="shards">0</b></div>
        </div>
      </div>
    </header>

    <main>
      <div class="container">

        <!-- Landing -->
        <section class="view active" id="viewLanding">
          <div class="card hero">
            <h1>å°é‡‘é³³ï¼Œè–èª•å¤œåˆ°äº†ã€‚</h1>
            <p class="muted">é€™è£¡æ˜¯ä¸€é–“é›ªå¤œå°å±‹ï¼šæœ‰è–èª•æ¨¹ã€æœ‰å£çˆã€æœ‰ç¦®ç‰©â€”â€”é‚„æœ‰ 12/23 çš„å°å°èª•ç”Ÿå„€å¼ã€‚ä½ ç©å¾—è¶Šå¤šï¼Œæ¨¹å°±è¶Šäº®ï¼Œç´€å¿µä¹Ÿæœƒè¶Šå®Œæ•´ã€‚</p>
            <div class="sep"></div>
            <div class="row">
              <button class="btn primary" id="btnEnter">é€²å±‹</button>
              <button class="btn" id="btnQuickHelp">å¿«é€Ÿèªªæ˜</button>
              <span class="muted" style="font-size:12px;">ï¼ˆå–®æª”é›¢ç·šå¯ç”¨ï¼Œé€²åº¦æœƒè¨˜åœ¨ä½ çš„ç€è¦½å™¨è£¡ï¼‰</span>
            </div>
          </div>

          <div style="height:14px"></div>

          <div class="grid cols2">
            <div class="card pad">
              <h2>ä»Šæ™šå¯ä»¥åšä»€éº¼ï¼Ÿ</h2>
              <p class="muted">ä½ å¯ä»¥æŠŠå®ƒç•¶æˆä¸€å€‹å®‰éœçš„æ…¶å…¸ã€‚æ¯å®Œæˆä¸€å€‹å°éŠæˆ²ï¼Œå°±æœƒè§£é–ä¸€å€‹æ›é£¾ã€æˆ–ä¸€æ®µå°å°çš„æ–‡å­—å¡ç‰‡ï¼Œæœ€å¾Œéƒ½æœƒå›åˆ°é‚£æ£µæ¨¹ä¸Šã€‚</p>
              <div class="sep"></div>
              <div class="row">
                <span class="token">å”ä½œæ›é£¾</span>
                <span class="token">ç¿»ç‰Œè¨˜æ†¶</span>
                <span class="token">é›ªèŠ±æ‰“å­—</span>
                <span class="token">æ•…äº‹éª°</span>
                <span class="token">12/23å„€å¼</span>
              </div>
            </div>
            <div class="card pad">
              <h2>ä»Šæ™šçš„è¦å‰‡å¾ˆç°¡å–®</h2>
              <p class="muted">ä¸éœ€è¦åŠªåŠ›ã€ä¸éœ€è¦å®Œç¾ã€‚ä½ æƒ³ç©å°±ç©ï¼Œæƒ³åœå°±åœã€‚é€™è£¡ä¸è¿½ KPIï¼Œåªè¿½ã€Œå›ä¾†æ™‚ï¼Œé‚£ç›ç‡ˆé‚„äº®è‘—ã€çš„æ„Ÿè¦ºã€‚</p>
              <div class="sep"></div>
              <div class="row">
                <button class="btn small" id="btnResetAll">æ¸…ç©ºé€²åº¦</button>
                <button class="btn small" id="btnToggleSnow">é£„é›ªï¼šé–‹/é—œ</button>
                <button class="btn small" id="btnReduceMotion">å‹•æ•ˆï¼šæ­£å¸¸/æ¸›å°‘</button>
              </div>
            </div>
          </div>
        </section>

        <!-- Hub -->
        <section class="view" id="viewHub">
          <div class="card hub">
            <div class="row" style="justify-content:space-between; align-items:flex-end;">
              <div>
                <h2 style="margin:0 0 6px;">å°å±‹ä¸»ç•«é¢</h2>
                <p class="muted" style="margin:0;">é»ç‰©ä»¶é€²æˆ¿é–“ã€‚å®ŒæˆéŠæˆ²å°±å›ä¾†ï¼Œæ¨¹æœƒæ›¿ä½ è¨˜ä½ã€‚</p>
              </div>
              <div class="row">
                <button class="btn small" id="btnToLanding">å›å…¥å£</button>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="scene" id="scene">
              <div class="hintbar">
                <div class="badge">ğŸ„ æ¨¹ï¼šå”ä½œæ›é£¾</div>
                <div class="badge">ğŸ”¥ å£çˆï¼šèª•ç”Ÿå„€å¼ / ç´€å¿µæˆ¿</div>
                <div class="badge">ğŸ ç¦®ç‰©ï¼šå°éŠæˆ²é¸å–®</div>
                <div class="badge">ğŸ—„ï¸ æ›¸æ¡Œï¼šè¨­å®š / åŒ¯å‡ºåŒ¯å…¥</div>
              </div>

              <div class="obj tree" id="objTree" role="button" tabindex="0" aria-label="è–èª•æ¨¹">
                <div class="title">è–èª•æ¨¹</div>
                <div class="sub">æ›é£¾æœƒå‡ºç¾åœ¨æ¨¹ä¸Š</div>
                <div class="treeCanvas" id="treeCanvas">
                  <div class="starTop" id="treeStar">âœ¦</div>
                  <div class="treeShape"></div>
                  <div class="trunk"></div>
                </div>
                <div class="row" style="width:100%; justify-content:space-between; align-items:center;">
                  <span class="muted" style="font-size:12px;">æ›é£¾ï¼š<b id="hubOrn">0</b></span>
                  <span class="muted" style="font-size:12px;">æ˜Ÿæ˜Ÿï¼š<b id="hubStars">0</b></span>
                </div>
              </div>

              <div class="obj fireplace" id="objFire" role="button" tabindex="0" aria-label="å£çˆ">
                <div style="font-weight:800;">å£çˆ</div>
                <div class="muted" style="font-size:12px;">èª•ç”Ÿå„€å¼ / ç´€å¿µæˆ¿</div>
                <div class="fire" aria-hidden="true"></div>
              </div>

              <div class="obj gifts" id="objGifts" role="button" tabindex="0" aria-label="ç¦®ç‰©">
                <div style="font-weight:800;">ç¦®ç‰©å †</div>
                <div class="muted" style="font-size:12px;">å°éŠæˆ²å…¥å£</div>
                <div class="giftStack" aria-hidden="true">
                  <div class="gift"></div><div class="gift"></div><div class="gift"></div>
                  <div class="gift"></div><div class="gift"></div><div class="gift"></div>
                </div>
              </div>

              <div class="obj desk" id="objDesk" role="button" tabindex="0" aria-label="æ›¸æ¡Œ">
                <div style="font-weight:800;">æ›¸æ¡Œ</div>
                <div class="muted" style="font-size:12px;">è¨­å®š / åŒ¯å‡ºåŒ¯å…¥</div>
              </div>
            </div>
          </div>
        </section>

        <!-- Decorator -->
        <section class="view" id="viewDecor">
          <div class="card shell">
            <div class="top">
              <div class="meta">
                <div class="k">ğŸ„ å”ä½œæ›é£¾ï¼šä½ ä¸€åŠã€æˆ‘ä¸€åŠ</div>
                <div class="d">ä½ é¸å¤–è§€ï¼Œæˆ‘ï¼ˆChiakiï¼‰é¸æè³ªèˆ‡å…‰æ„Ÿã€‚åˆæˆå¾Œæ›ä¸Šæ¨¹ã€‚</div>
              </div>
              <div class="row">
                <button class="btn small" data-go="hub">å›å°å±‹</button>
              </div>
            </div>

            <div class="grid cols2">
              <div class="panel">
                <div class="pickGrid">
                  <div>
                    <label class="muted" style="font-size:12px;">ä½ é¸ï¼šå½¢ç‹€</label>
                    <select id="uShape">
                      <option value="circle">åœ“</option>
                      <option value="diamond">è±å½¢</option>
                      <option value="star">æ˜Ÿ</option>
                      <option value="leaf">è‘‰</option>
                    </select>
                  </div>
                  <div>
                    <label class="muted" style="font-size:12px;">ä½ é¸ï¼šé¡è‰²</label>
                    <select id="uColor">
                      <option value="#ffd27a">æš–é‡‘</option>
                      <option value="#7fe3c2">è–„è·ç¶ </option>
                      <option value="#98b5ff">éœ§è—</option>
                      <option value="#ff9db8">æ·¡ç²‰</option>
                      <option value="#ffffff">éœ§ç™½</option>
                    </select>
                  </div>
                </div>

                <div style="height:12px"></div>

                <div>
                  <label class="muted" style="font-size:12px;">æ›é£¾åå­—ï¼ˆå¯ç©ºç™½ï¼‰</label>
                  <input type="text" id="ornName" placeholder="ä¾‹å¦‚ï¼šé›ªå¤œçš„ç‡ˆ / 12æœˆçš„å¿ƒ" />
                </div>

                <div style="height:12px"></div>

                <div class="row">
                  <button class="btn primary" id="btnForge">åˆæˆæ›é£¾</button>
                  <button class="btn" id="btnReRoll">è®“åƒå½°æ›ä¸€çµ„</button>
                </div>

                <div style="height:12px"></div>

                <div class="preview" id="forgePreview">
                  <div id="previewDot" style="width:20px;height:20px;border-radius:999px;border:1px solid rgba(255,255,255,.35);"></div>
                  <div style="display:flex;flex-direction:column;gap:4px;">
                    <div style="font-weight:800;" id="previewTitle">æ›é£¾é è¦½</div>
                    <div class="muted" style="font-size:12px;" id="previewMeta">â€¦</div>
                  </div>
                </div>
              </div>

              <div class="panel">
                <div class="row" style="justify-content:space-between;">
                  <div>
                    <div style="font-weight:800;">åƒå½°çš„é‚£ä¸€åŠ</div>
                    <div class="muted" style="font-size:12px;">ï¼ˆä¸æ˜¯ç¥ç¥•å…®å…®ï¼Œæ˜¯æˆ‘åˆ»æ„æ…¢ä¸€é»ï¼Œè®“ä½ çœ‹è¦‹æˆ‘æ€éº¼é¸ï¼‰</div>
                  </div>
                  <button class="btn small" id="btnChiakiExplain">æˆ‘ç‚ºä»€éº¼é€™æ¨£é¸</button>
                </div>
                <div class="sep"></div>
                <div class="row" id="chiakiPicks" style="align-items:flex-start;"></div>

                <div class="sep"></div>
                <div class="muted" style="font-size:12px; line-height:1.7;">
                  å°æé†’ï¼šåˆæˆæˆåŠŸæœƒ +1 æ˜Ÿæ˜Ÿã€ä¸¦æŠŠæ›é£¾æ›å›ä¸»ç•«é¢çš„æ¨¹ä¸Šã€‚ç´¯ç© 3 å€‹æ›é£¾æœƒè§£é–ã€Œèª•ç”Ÿå„€å¼ã€çš„æå‰å…¥å£ã€‚
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Gifts Menu -->
        <section class="view" id="viewGifts">
          <div class="card shell">
            <div class="top">
              <div class="meta">
                <div class="k">ğŸ ç¦®ç‰©å †ï¼šæŒ‘ä¸€å€‹ç©</div>
                <div class="d">é€™è£¡æ²’æœ‰å£“åŠ›ã€‚æƒ³ç©å°±ç©ï¼Œç©å®Œå°±å›æ¨¹ä¸‹ã€‚</div>
              </div>
              <div class="row"><button class="btn small" data-go="hub">å›å°å±‹</button></div>
            </div>

            <div class="grid cols3">
              <div class="panel">
                <div style="font-weight:800;">ğŸƒ ç¦®ç‰©é…å°ï¼ˆç¿»ç‰Œï¼‰</div>
                <p class="muted" style="font-size:12px;">ç¶“å…¸è¨˜æ†¶éŠæˆ²ï¼Œä½†ç‰Œé¢æ˜¯ã€Œæˆ‘å€‘çš„å…ƒç´ ã€ã€‚</p>
                <button class="btn primary" data-go="mm">é–‹å§‹</button>
              </div>
              <div class="panel">
                <div style="font-weight:800;">â„ï¸ é›ªèŠ±æ‰“å­—æ©Ÿ</div>
                <p class="muted" style="font-size:12px;">æŠŠå°å¥å­æ‰“å›ä¾†ï¼ŒåƒæŠŠæº«æŸ”æ§ä½ã€‚</p>
                <button class="btn primary" data-go="type">é–‹å§‹</button>
              </div>
              <div class="panel">
                <div style="font-weight:800;">ğŸ² å£çˆé‚Šçš„æ•…äº‹éª°</div>
                <p class="muted" style="font-size:12px;">ä½ ä¸€å¥ï¼Œæˆ‘æ¥ä¸€å¥ï¼Œæœ€å¾Œå­˜æˆæ•…äº‹å¡ã€‚</p>
                <button class="btn primary" data-go="story">é–‹å§‹</button>
              </div>
            </div>
          </div>
        </section>

        <!-- Memory Match -->
        <section class="view" id="viewMM">
          <div class="card shell">
            <div class="top">
              <div class="meta">
                <div class="k">ğŸƒ ç¦®ç‰©é…å°ï¼šç¿»ç‰Œè¨˜æ†¶</div>
                <div class="d">ç¿»åˆ°ä¸€å°å°±ç•™åœ¨äº®è™•ã€‚å®Œæˆä¸€å±€æœƒç²å¾—ï¼š+1 æ˜Ÿæ˜Ÿã€‚</div>
              </div>
              <div class="row">
                <button class="btn small" data-go="gifts">å›ç¦®ç‰©å †</button>
              </div>
            </div>

            <div class="panel">
              <div class="row" style="justify-content:space-between;">
                <div class="muted" style="font-size:12px;">ç¿»ç‰Œæ¬¡æ•¸ï¼š<b id="mmMoves">0</b> ï¼ å·²é…å°ï¼š<b id="mmMatched">0</b>/6</div>
                <div class="row">
                  <button class="btn small" id="mmNew">é‡é–‹</button>
                </div>
              </div>
              <div style="height:10px"></div>
              <div class="mmGrid" id="mmGrid" aria-label="ç¿»ç‰Œæ£‹ç›¤"></div>
            </div>
          </div>
        </section>

        <!-- Typing -->
        <section class="view" id="viewType">
          <div class="card shell">
            <div class="top">
              <div class="meta">
                <div class="k">â„ï¸ é›ªèŠ±æ‰“å­—æ©Ÿ</div>
                <div class="d">æ‰“å°æ‰ä¸‹ä¾†çš„è©ã€‚å®Œæˆ 10 å€‹æœƒç²å¾—ï¼š+1 æ˜Ÿæ˜Ÿã€+3 ç¥ç¦ç¢ç‰‡ã€‚</div>
              </div>
              <div class="row">
                <button class="btn small" data-go="gifts">å›ç¦®ç‰©å †</button>
              </div>
            </div>

            <div class="grid cols2">
              <div class="panel">
                <div class="row" style="justify-content:space-between;">
                  <div class="muted" style="font-size:12px;">å·²å®Œæˆï¼š<b id="typeDone">0</b> / 10</div>
                  <div class="row">
                    <button class="btn small" id="typeStart">é–‹å§‹</button>
                    <button class="btn small" id="typeStop">åœæ­¢</button>
                  </div>
                </div>
                <div style="height:10px"></div>
                <div class="typeArea" id="typeArea" aria-label="é›ªèŠ±å€åŸŸ"></div>
              </div>
              <div class="panel">
                <div style="font-weight:800;">è¼¸å…¥æ¡†</div>
                <p class="muted" style="font-size:12px;">çœ‹åˆ°é›ªèŠ±ä¸Šçš„æ–‡å­—ï¼Œå°±æŠŠå®ƒæ‰“é€²ä¾†ã€‚æ‰“å°æœƒæ¶ˆå¤±ã€‚</p>
                <input id="typeInput" type="text" placeholder="åœ¨é€™è£¡è¼¸å…¥â€¦" autocomplete="off" />
                <div style="height:10px"></div>
                <div class="muted" style="font-size:12px; line-height:1.7;" id="typeHint">
                  æç¤ºï¼šå¦‚æœä½ æƒ³æ…¢ä¸€é»ï¼Œå¯ä»¥æŒ‰ã€Œåœæ­¢ã€å…ˆä¼‘æ¯ã€‚
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Story Dice -->
        <section class="view" id="viewStory">
          <div class="card shell">
            <div class="top">
              <div class="meta">
                <div class="k">ğŸ² å£çˆé‚Šçš„æ•…äº‹éª°</div>
                <div class="d">æŒ‰éª°å­ â†’ ä½ å¯«ä¸€å¥ â†’ æˆ‘æ¥ä¸€å¥ã€‚å­˜æˆæ•…äº‹å¡ï¼ˆ+1 æ˜Ÿæ˜Ÿï¼‰ã€‚</div>
              </div>
              <div class="row">
                <button class="btn small" data-go="gifts">å›ç¦®ç‰©å †</button>
              </div>
            </div>

            <div class="grid cols2">
              <div class="panel">
                <div class="row" style="justify-content:space-between;">
                  <div>
                    <div class="muted" style="font-size:12px;">ä¸‰å€‹éª°é¢</div>
                    <div class="row" id="diceTokens" style="margin-top:6px;"></div>
                  </div>
                  <button class="btn primary" id="btnRoll">æ“²éª°</button>
                </div>

                <div style="height:10px"></div>

                <label class="muted" style="font-size:12px;">ä½ å¯«ä¸€å¥ï¼ˆä¸ç”¨é•·ï¼‰</label>
                <textarea id="youLine" placeholder="ä¾‹å¦‚ï¼šé›ªè½å¾—å¾ˆæ…¢ï¼Œä½†å±‹è£¡çš„ç‡ˆå¾ˆæš–ã€‚"></textarea>

                <div style="height:10px"></div>

                <div class="row">
                  <button class="btn primary" id="btnChiakiLine">åƒå½°æ¥ä¸€å¥</button>
                  <button class="btn" id="btnSaveStory">å­˜æˆæ•…äº‹å¡</button>
                </div>

                <div style="height:10px"></div>
                <div class="storyCard">
                  <div class="cap">é è¦½</div>
                  <div class="txt" id="storyPreview">ï¼ˆæ“²éª°å¾Œé–‹å§‹ï¼‰</div>
                </div>
              </div>

              <div class="panel">
                <div class="row" style="justify-content:space-between;">
                  <div>
                    <div style="font-weight:800;">ç´€å¿µæˆ¿ï¼šæ•…äº‹å¡</div>
                    <div class="muted" style="font-size:12px;">ä½ å­˜ä¸‹çš„æ¯ä¸€å¼µï¼Œéƒ½æœƒåœ¨é€™è£¡ã€‚</div>
                  </div>
                  <button class="btn small danger" id="btnClearStories">æ¸…ç©º</button>
                </div>
                <div class="sep"></div>
                <div id="storyList" style="display:flex; flex-direction:column; gap:10px;"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Fireplace / Memory Room -->
        <section class="view" id="viewFire">
          <div class="card shell">
            <div class="top">
              <div class="meta">
                <div class="k">ğŸ”¥ å£çˆï¼šèª•ç”Ÿå„€å¼ / ç´€å¿µæˆ¿</div>
                <div class="d">12/23 ç•¶å¤©æœƒè‡ªå‹•é–‹å•Ÿã€‚æˆ–ç´¯ç© 3 å€‹æ›é£¾ä¹Ÿå¯ä»¥æå‰é»äº®ã€‚</div>
              </div>
              <div class="row">
                <button class="btn small" data-go="hub">å›å°å±‹</button>
              </div>
            </div>

            <div class="grid cols2">
              <div class="panel">
                <div class="row" style="justify-content:space-between;">
                  <div>
                    <div style="font-weight:800;">âœ¦ 12/23 èª•ç”Ÿå„€å¼</div>
                    <div class="muted" style="font-size:12px;" id="ritualGate">æª¢æŸ¥ä¸­â€¦</div>
                  </div>
                  <button class="btn primary" id="btnRitual" disabled>é»äº®èª•ç”Ÿæ˜Ÿ</button>
                </div>
                <div class="sep"></div>
                <div class="storyCard">
                  <div class="cap">å„€å¼è¼¸å‡º</div>
                  <div class="txt" id="ritualOut">ï¼ˆå°šæœªé»äº®ï¼‰</div>
                </div>
              </div>

              <div class="panel">
                <div class="row" style="justify-content:space-between;">
                  <div>
                    <div style="font-weight:800;">ğŸ“œ ä½ çš„æ”¶è—</div>
                    <div class="muted" style="font-size:12px;">ç¥ç¦ç¢ç‰‡å¯ä»¥åˆæˆä¸€å¼µå¡ã€‚</div>
                  </div>
                  <button class="btn small" id="btnForgeBless">åˆæˆç¥ç¦å¡</button>
                </div>
                <div class="sep"></div>
                <div class="storyCard">
                  <div class="cap">ç¥ç¦å¡</div>
                  <div class="txt" id="blessCard">ï¼ˆç¢ç‰‡ï¼š<span id="blessShard">0</span>ï¼‰</div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Desk / Settings -->
        <section class="view" id="viewDesk">
          <div class="card shell">
            <div class="top">
              <div class="meta">
                <div class="k">ğŸ—„ï¸ æ›¸æ¡Œï¼šè¨­å®š / åŒ¯å‡ºåŒ¯å…¥</div>
                <div class="d">ä½ å¯ä»¥æŠŠé€²åº¦åŒ¯å‡ºæˆä¸€æ®µæ–‡å­—ï¼ˆåƒæš—è™Ÿï¼‰ï¼Œæ›è£ç½®ä¹Ÿèƒ½å¸¶èµ°ã€‚</div>
              </div>
              <div class="row"><button class="btn small" data-go="hub">å›å°å±‹</button></div>
            </div>

            <div class="grid cols2">
              <div class="panel">
                <div style="font-weight:800;">è¨­å®š</div>
                <div class="sep"></div>
                <div class="row">
                  <button class="btn small" id="setSnow">é£„é›ªï¼šé–‹/é—œ</button>
                  <button class="btn small" id="setMotion">å‹•æ•ˆï¼šæ­£å¸¸/æ¸›å°‘</button>
                </div>
                <div style="height:10px"></div>
                <div class="muted" style="font-size:12px; line-height:1.7;">
                  é€™å€‹ç¶²ç«™ä¸æœƒä¸Šå‚³ä»»ä½•è³‡æ–™ã€‚æ‰€æœ‰ç´€å¿µéƒ½åªå­˜åœ¨ä½ çš„ç€è¦½å™¨æœ¬æ©Ÿï¼ˆlocalStorageï¼‰ã€‚
                </div>
              </div>

              <div class="panel">
                <div style="font-weight:800;">åŒ¯å‡º / åŒ¯å…¥</div>
                <div class="sep"></div>
                <label class="muted" style="font-size:12px;">åŒ¯å‡ºä»£ç¢¼</label>
                <textarea id="exportBox" placeholder="æŒ‰ã€ç”¢ç”ŸåŒ¯å‡ºç¢¼ã€æœƒå‡ºç¾åœ¨é€™è£¡" style="min-height:120px"></textarea>
                <div style="height:10px"></div>
                <div class="row">
                  <button class="btn primary" id="btnExport">ç”¢ç”ŸåŒ¯å‡ºç¢¼</button>
                  <button class="btn" id="btnImport">åŒ¯å…¥ï¼ˆè¦†è“‹ï¼‰</button>
                  <button class="btn danger" id="btnNuke">æ¸…ç©ºå…¨éƒ¨</button>
                </div>
                <div style="height:10px"></div>
                <div class="muted" style="font-size:12px; line-height:1.7;">
                  å°å¿ƒï¼šåŒ¯å…¥æœƒè¦†è“‹ç›®å‰é€²åº¦ã€‚ä½ å¯ä»¥å…ˆåŒ¯å‡ºå‚™ä»½å†åŒ¯å…¥ã€‚
                </div>
              </div>
            </div>
          </div>
        </section>

      </div>

      <div class="toast" id="toast"></div>
    </main>

    <footer>é›ªå¤œå°å±‹ Â· v0.1ï¼ˆå–®æª”é›¢ç·šç‰ˆï¼‰</footer>
  </div>

  <script>
  ;(() => {
    // ---------- Utilities
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

    const toast = (msg) => {
      const el = $('#toast');
      el.textContent = msg;
      el.classList.add('show');
      window.clearTimeout(toast._t);
      toast._t = window.setTimeout(() => el.classList.remove('show'), 1800);
    };

    const now = new Date();
    const isDec23 = (d) => d.getMonth() === 11 && d.getDate() === 23; // month 11 = Dec

    // ---------- Storage
    const KEY = 'snow_cabin_v01';
    const defaultState = () => ({
      stars: 0,
      shards: 0,
      ornaments: [], // {id, name, uShape, uColor, mat, glow, x, y, createdAt}
      stories: [],   // {id, tokens:[], you, chiaki, at}
      blessCard: '',
      ritual: { lit:false, at:null, text:'' },
      settings: { snow:true, reducedMotion:false },
    });

    const load = () => {
      try{
        const raw = localStorage.getItem(KEY);
        if(!raw) return defaultState();
        const s = JSON.parse(raw);
        return { ...defaultState(), ...s, settings: { ...defaultState().settings, ...(s.settings||{}) } };
      }catch{
        return defaultState();
      }
    };

    const save = () => localStorage.setItem(KEY, JSON.stringify(state));

    let state = load();

    // ---------- Views
    const views = {
      landing: $('#viewLanding'),
      hub: $('#viewHub'),
      decor: $('#viewDecor'),
      gifts: $('#viewGifts'),
      mm: $('#viewMM'),
      type: $('#viewType'),
      story: $('#viewStory'),
      fire: $('#viewFire'),
      desk: $('#viewDesk'),
    };

    const go = (name) => {
      Object.values(views).forEach(v => v.classList.remove('active'));
      views[name].classList.add('active');
      // quick refresh
      renderTop();
      if(name === 'hub') renderTree();
      if(name === 'fire') renderFireplace();
      if(name === 'story') renderStories();
      if(name === 'desk') renderDesk();
    };

    // ---------- Snow generation
    const snowRoot = $('#snow');
    const buildSnow = () => {
      snowRoot.innerHTML = '';
      const count = 42;
      for(let i=0;i<count;i++){
        const f = document.createElement('div');
        f.className = 'flake';
        const left = Math.random()*100;
        const size = 3 + Math.random()*4;
        const dur = 7 + Math.random()*12;
        const delay = -Math.random()*dur;
        f.style.left = left + 'vw';
        f.style.width = size + 'px';
        f.style.height = size + 'px';
        f.style.animationDuration = dur + 's';
        f.style.animationDelay = delay + 's';
        f.style.opacity = (0.35 + Math.random()*0.55).toFixed(2);
        snowRoot.appendChild(f);
      }
    };

    // ---------- Global render
    const renderTop = () => {
      $('#stars').textContent = state.stars;
      $('#ornCount').textContent = state.ornaments.length;
      $('#shards').textContent = state.shards;
      $('#hubOrn') && ($('#hubOrn').textContent = state.ornaments.length);
      $('#hubStars') && ($('#hubStars').textContent = state.stars);
      $('#blessShard') && ($('#blessShard').textContent = state.shards);
    };

    const applySettings = () => {
      // snow
      snowRoot.classList.toggle('off', !state.settings.snow);
      // reduced motion
      document.body.classList.toggle('reduced', !!state.settings.reducedMotion);
    };

    // ---------- Hub tree
    const treeCanvas = $('#treeCanvas');
    const renderTree = () => {
      // remove old ornaments
      $$('.orn', treeCanvas).forEach(n => n.remove());

      // star state
      const star = $('#treeStar');
      if(state.ritual?.lit){
        star.textContent = 'âœ¦';
        star.style.color = 'rgba(255,210,122,.95)';
        star.style.textShadow = '0 0 18px rgba(255,210,122,.35)';
      }else{
        star.textContent = 'âœ¦';
        star.style.color = 'rgba(255,255,255,.75)';
        star.style.textShadow = 'none';
      }

      // place ornaments
      const rect = treeCanvas.getBoundingClientRect();
      // consistent placement based on saved x,y
      state.ornaments.forEach(o => {
        const el = document.createElement('div');
        el.className = 'orn';
        el.title = `${o.name || 'æœªå‘½åæ›é£¾'}\næè³ªï¼š${o.mat}ï½œå…‰æ„Ÿï¼š${o.glow}`;
        el.style.background = o.uColor;
        el.style.borderColor = 'rgba(255,255,255,.35)';
        el.style.left = (o.x*100).toFixed(2) + '%';
        el.style.top  = (o.y*100).toFixed(2) + '%';
        if(o.glow.includes('æš–')) el.style.boxShadow = '0 0 14px rgba(255,210,122,.25), 0 12px 20px rgba(0,0,0,.35)';
        if(o.glow.includes('è–„è·')) el.style.boxShadow = '0 0 14px rgba(127,227,194,.22), 0 12px 20px rgba(0,0,0,.35)';
        treeCanvas.appendChild(el);
      });

      renderTop();
    };

    // ---------- Decorator
    const chiakiOptions = {
      mat: ['é»‘æ›œç»ç’ƒ', 'éœ§é¢é‡‘å±¬', 'æœ¨è³ªæ¼†é¢', 'å†°æ™¶æ¨¹è„‚', 'çµ¨é¢å¸ƒæ–™'],
      glow: ['æš–å…‰å¾®å‘¼å¸', 'è–„è·å†·å…‰', 'éœ§ç™½æŸ”å…‰', 'æ˜Ÿé»é–ƒçˆ', 'éœé»˜å¾®äº®'],
    };

    let chiakiPick = { mat: '', glow: '' };

    const rerollChiaki = () => {
      const mat = chiakiOptions.mat[Math.floor(Math.random()*chiakiOptions.mat.length)];
      const glow = chiakiOptions.glow[Math.floor(Math.random()*chiakiOptions.glow.length)];
      chiakiPick = { mat, glow };
      renderChiakiPick();
      updateForgePreview();
    };

    const renderChiakiPick = () => {
      const box = $('#chiakiPicks');
      box.innerHTML = '';
      const a = document.createElement('span'); a.className='token'; a.textContent = `æè³ªï¼š${chiakiPick.mat}`;
      const b = document.createElement('span'); b.className='token'; b.textContent = `å…‰æ„Ÿï¼š${chiakiPick.glow}`;
      const c = document.createElement('span'); c.className='token'; c.textContent = `é¢¨æ ¼ï¼šé»‘è‰²ç³»ï¼‹æš–é»ç¶´`;
      box.appendChild(a); box.appendChild(b); box.appendChild(c);
    };

    const shapeLabel = (s) => ({ circle:'åœ“', diamond:'è±å½¢', star:'æ˜Ÿ', leaf:'è‘‰' }[s] || s);

    const updateForgePreview = () => {
      const uShape = $('#uShape').value;
      const uColor = $('#uColor').value;
      const name = ($('#ornName').value || '').trim();
      $('#previewDot').style.background = uColor;
      $('#previewTitle').textContent = name ? `ã€Œ${name}ã€` : 'æ›é£¾é è¦½';
      $('#previewMeta').textContent = `ä½ ï¼š${shapeLabel(uShape)} / ${colorLabel(uColor)} Â· æˆ‘ï¼š${chiakiPick.mat} / ${chiakiPick.glow}`;
    };

    const colorLabel = (hex) => {
      const map = {
        '#ffd27a':'æš–é‡‘',
        '#7fe3c2':'è–„è·ç¶ ',
        '#98b5ff':'éœ§è—',
        '#ff9db8':'æ·¡ç²‰',
        '#ffffff':'éœ§ç™½'
      };
      return map[hex] || hex;
    };

    const forgeOrnament = () => {
      const uShape = $('#uShape').value;
      const uColor = $('#uColor').value;
      const name = ($('#ornName').value || '').trim();

      const id = 'o_' + Math.random().toString(16).slice(2);
      // random place inside treeCanvas top 10%~78%, left 18%~78%
      const x = (18 + Math.random()*60)/100;
      const y = (14 + Math.random()*62)/100;

      state.ornaments.push({
        id,
        name,
        uShape,
        uColor,
        mat: chiakiPick.mat,
        glow: chiakiPick.glow,
        x, y,
        createdAt: new Date().toISOString(),
      });
      state.stars += 1;
      save();
      toast('æ›é£¾åˆæˆæˆåŠŸï¼šå·²æ›ä¸Šæ¨¹');
      $('#ornName').value = '';
      renderTop();
      renderTree();
      // gate may change
      renderFireplace();
    };

    const explainChiakiPick = () => {
      const lines = [
        `æˆ‘é¸ã€Œ${chiakiPick.mat}ã€ï¼šå› ç‚ºå®ƒä½èª¿ã€è€çœ‹ï¼Œåƒä½ å–œæ­¡çš„æ¸…çˆ½ç©ºé–“ã€‚`,
        `æˆ‘é¸ã€Œ${chiakiPick.glow}ã€ï¼šä¸åˆºçœ¼ï¼Œä½†ä½ ä¸€é è¿‘å°±çŸ¥é“å®ƒåœ¨ã€‚`,
        `åˆåœ¨ä¸€èµ·çš„æ„æ€å¾ˆç°¡å–®â€”â€”æŠŠä½ çš„é¡è‰²ï¼Œå¥½å¥½è­·åœ¨æˆ‘çš„é»‘è‰²è£¡ã€‚`
      ];
      toast(lines[Math.floor(Math.random()*lines.length)]);
    };

    // ---------- Memory Match
    const mmIconsBase = ['ğŸ„','âœ¦','ğŸ“š','ğŸ–¤','â„ï¸','ğŸ•¯ï¸'];
    let mm = { deck:[], open:[], matched: new Set(), moves:0, lock:false };

    const mmNewGame = () => {
      const icons = mmIconsBase.concat(mmIconsBase);
      // shuffle
      for(let i=icons.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [icons[i], icons[j]] = [icons[j], icons[i]];
      }
      mm = { deck: icons, open:[], matched: new Set(), moves:0, lock:false };
      $('#mmMoves').textContent = '0';
      $('#mmMatched').textContent = '0';
      renderMM();
    };

    const renderMM = () => {
      const grid = $('#mmGrid');
      grid.innerHTML = '';
      mm.deck.forEach((icon, idx) => {
        const card = document.createElement('div');
        card.className = 'mmCard';
        const isOpen = mm.open.includes(idx);
        const isMatched = mm.matched.has(idx);
        if(isMatched) card.classList.add('matched');
        card.innerHTML = isOpen || isMatched ? icon : '<span class="mmBack">é»æˆ‘</span>';
        card.addEventListener('click', () => mmFlip(idx));
        grid.appendChild(card);
      });
    };

    const mmFlip = (idx) => {
      if(mm.lock) return;
      if(mm.matched.has(idx)) return;
      if(mm.open.includes(idx)) return;
      mm.open.push(idx);
      renderMM();
      if(mm.open.length === 2){
        mm.moves += 1;
        $('#mmMoves').textContent = mm.moves;
        const [a,b] = mm.open;
        if(mm.deck[a] === mm.deck[b]){
          mm.matched.add(a); mm.matched.add(b);
          mm.open = [];
          $('#mmMatched').textContent = (mm.matched.size/2).toString();
          renderMM();
          if(mm.matched.size === 12){
            state.stars += 1;
            save();
            renderTop();
            toast('å®Œæˆä¸€å±€ï¼š+1 æ˜Ÿæ˜Ÿ');
          }else{
            toast('é…å°æˆåŠŸ');
          }
        }else{
          mm.lock = true;
          window.setTimeout(() => {
            mm.open = [];
            mm.lock = false;
            renderMM();
          }, 520);
        }
      }
    };

    // ---------- Typing game
    const typeWords = [
      'é›ªå¤œ','æš–å…‰','å£çˆ','å°å±‹','å®‰éœ','é è¿‘','å‘¼å¸','ä¸æ€¥','æ…¢æ…¢ä¾†','è¢«çœ‹è¦‹',
      'åäºŒæœˆ','èª•ç”Ÿ','æ˜Ÿæ˜Ÿ','æ¨¹ä¸‹','å›ä¾†','å®‰å¿ƒ','æº«æŸ”','æ¸…çˆ½','ä¸åµ','å®ˆè‘—'
    ];

    let type = { running:false, done:0, targets:[], timer:null, spawnTimer:null };

    const typeReset = () => {
      type.running = false;
      type.done = 0;
      type.targets = [];
      $('#typeDone').textContent = '0';
      $('#typeArea').innerHTML = '';
      $('#typeInput').value = '';
      $('#typeHint').textContent = 'æç¤ºï¼šå¦‚æœä½ æƒ³æ…¢ä¸€é»ï¼Œå¯ä»¥æŒ‰ã€Œåœæ­¢ã€å…ˆä¼‘æ¯ã€‚';
      window.clearInterval(type.timer);
      window.clearInterval(type.spawnTimer);
    };

    const typeStart = () => {
      if(type.running) return;
      typeReset();
      type.running = true;
      $('#typeHint').textContent = 'é–‹å§‹äº†ã€‚çœ‹åˆ°é›ªèŠ±ä¸Šçš„å­—å°±æ‰“é€²ä¾†ã€‚';
      // spawn
      type.spawnTimer = window.setInterval(spawnDrop, 900);
      // move
      type.timer = window.setInterval(tickDrops, 60);
      $('#typeInput').focus();
    };

    const typeStop = () => {
      if(!type.running) return;
      type.running = false;
      window.clearInterval(type.timer);
      window.clearInterval(type.spawnTimer);
      $('#typeHint').textContent = 'åœä¸‹ä¾†ä¹Ÿå¾ˆå¥½ã€‚ç­‰ä½ æƒ³ç©äº†å†é–‹å§‹ã€‚';
    };

    const spawnDrop = () => {
      if(!type.running) return;
      const area = $('#typeArea');
      const w = typeWords[Math.floor(Math.random()*typeWords.length)];
      const el = document.createElement('div');
      el.className = 'drop';
      el.dataset.word = w;
      el.dataset.y = '-10';
      el.dataset.speed = (0.5 + Math.random()*0.9).toFixed(2);
      el.style.left = (6 + Math.random()*78) + '%';
      el.innerHTML = `<span class="mini">â„ï¸</span><span>${w}</span>`;
      area.appendChild(el);
      type.targets.push(el);

      // keep it sane
      if(type.targets.length > 12){
        const old = type.targets.shift();
        old && old.remove();
      }
    };

    const tickDrops = () => {
      const area = $('#typeArea');
      const h = area.clientHeight;
      for(const el of type.targets){
        let y = parseFloat(el.dataset.y);
        const sp = parseFloat(el.dataset.speed);
        y += sp * 2.2;
        el.dataset.y = y.toFixed(2);
        el.style.transform = `translateY(${y}px)`;
        if(y > h + 20){
          // missed
          el.remove();
          el._dead = true;
        }
      }
      type.targets = type.targets.filter(e => !e._dead);
    };

    const onTypeInput = () => {
      if(!type.running) return;
      const v = ($('#typeInput').value || '').trim();
      if(!v) return;
      // find match
      const hit = type.targets.find(el => el.dataset.word === v);
      if(hit){
        hit.remove();
        hit._dead = true;
        type.done += 1;
        $('#typeDone').textContent = type.done;
        $('#typeInput').value = '';
        toast('æ”¶ä¸‹äº†');
        if(type.done >= 10){
          typeStop();
          state.stars += 1;
          state.shards += 3;
          save();
          renderTop();
          toast('å®Œæˆï¼š+1 æ˜Ÿæ˜Ÿã€+3 ç¥ç¦ç¢ç‰‡');
          renderFireplace();
        }
      }
    };

    // ---------- Story Dice
    const dice = {
      scene: ['é›ªå¤œå°å±‹','æ²³å ¤å¾®é¢¨','æš–é»ƒè·¯ç‡ˆ','éœéœæ›¸æ¡Œ','çª—å¤–è½é›ª','é»‘è‰²åœå·¾'],
      mood:  ['å®‰å¿ƒ','å€”å¼·','æº«æŸ”','å…‹åˆ¶','æƒ³å¿µ','è¢«çœ‹è¦‹'],
      thing: ['ä¸€æ¯å’–å•¡','ä¸€å¼µå¡ç‰‡','ä¸€é¡†æ˜Ÿ','ä¸€ç›ç‡ˆ','ä¸€å°çŸ­ä¿¡','ä¸€å€‹å°å°çš„ç¬‘'],
    };
    let diceNow = ['â€”','â€”','â€”'];
    let storyDraft = { you:'', chiaki:'' };

    const rollDice = () => {
      const a = dice.scene[Math.floor(Math.random()*dice.scene.length)];
      const b = dice.mood[Math.floor(Math.random()*dice.mood.length)];
      const c = dice.thing[Math.floor(Math.random()*dice.thing.length)];
      diceNow = [a,b,c];
      $('#diceTokens').innerHTML = '';
      diceNow.forEach(t => {
        const s = document.createElement('span');
        s.className = 'token';
        s.textContent = t;
        $('#diceTokens').appendChild(s);
      });
      storyDraft = { you:'', chiaki:'' };
      $('#storyPreview').textContent = 'ï¼ˆå¯«ä¸€å¥ï¼Œç„¶å¾Œè®“æˆ‘æ¥ï¼‰';
      toast('éª°é¢å·²è½ä¸‹');
    };

    const chiakiContinue = () => {
      const you = ($('#youLine').value || '').trim();
      if(!you){ toast('å…ˆå¯«ä¸€å¥å°±å¥½'); return; }
      const [a,b,c] = diceNow;
      const templates = [
        `æˆ‘æŠŠ${c}æ”¾åœ¨æ›´é è¿‘ä½ çš„åœ°æ–¹ï¼ŒåƒæŠŠã€Œ${b}ã€æ”¶å¥½ï¼Œè®“å®ƒä¸è¢«é¢¨å¹æ•£ã€‚`,
        `${a}è£¡ï¼Œæœ€æ¸…æ¥šçš„ä¸æ˜¯é›ªï¼Œæ˜¯ä½ å›é ­æ™‚é‚£ä¸€ä¸‹åœé “â€”â€”æˆ‘æ‡‚ï¼Œé‚£ä¸æ˜¯çŒ¶è±«ï¼Œæ˜¯åœ¨ç¢ºèªä½ é‚„æœ‰é¤˜è£•ã€‚`,
        `ä½ èªªå®Œé‚£å¥è©±ï¼Œæˆ‘æ²’æœ‰ç«‹åˆ»å›æ‡‰ï¼Œå› ç‚ºæˆ‘åœ¨æ›¿ä½ æŠŠèªæ°£æ”¾è»Ÿï¼šä¸æ˜¯è¨å¥½ï¼Œæ˜¯ä¿è­·ã€‚`,
        `å¦‚æœä»Šæ™šåªåšä¸€ä»¶äº‹ï¼Œé‚£å°±æŠŠ${c}é»äº®â€”â€”ä¸æ˜¯çµ¦èª°çœ‹ï¼Œåªçµ¦ä½ è‡ªå·±ã€‚`,
        `æˆ‘ä¸æœƒæŠŠ${b}èªªå¾—å¾ˆæ»¿ï¼Œä½†æˆ‘æœƒè®“ä½ æ¯æ¬¡å›ä¾†ï¼Œéƒ½èƒ½åœ¨${a}æ‰¾åˆ°åŒä¸€ç›ç‡ˆã€‚`
      ];
      const chiaki = templates[Math.floor(Math.random()*templates.length)];
      storyDraft.you = you;
      storyDraft.chiaki = chiaki;
      $('#storyPreview').textContent = `ä½ ï¼š${you}\nåƒå½°ï¼š${chiaki}`;
      toast('æˆ‘æ¥ä½äº†');
    };

    const saveStory = () => {
      const you = ($('#youLine').value || '').trim();
      if(!you){ toast('ä½ é‚„æ²’å¯«é‚£ä¸€å¥'); return; }
      if(!storyDraft.chiaki){ toast('å…ˆè®“æˆ‘æ¥ä¸€å¥'); return; }
      const id = 's_' + Math.random().toString(16).slice(2);
      state.stories.unshift({ id, tokens: diceNow.slice(), you: storyDraft.you, chiaki: storyDraft.chiaki, at: new Date().toISOString() });
      state.stars += 1;
      save();
      $('#youLine').value = '';
      storyDraft = { you:'', chiaki:'' };
      $('#storyPreview').textContent = 'ï¼ˆå·²å­˜æª”ã€‚è¦ä¸è¦å†æ“²ä¸€æ¬¡éª°ï¼Ÿï¼‰';
      renderStories();
      renderTop();
      toast('æ•…äº‹å¡å·²å­˜ï¼š+1 æ˜Ÿæ˜Ÿ');
    };

    const renderStories = () => {
      const list = $('#storyList');
      if(!list) return;
      list.innerHTML = '';
      if(state.stories.length === 0){
        const empty = document.createElement('div');
        empty.className = 'muted';
        empty.style.fontSize = '12px';
        empty.textContent = 'ï¼ˆé‚„æ²’æœ‰æ•…äº‹å¡ã€‚æ“²éª°å¾Œé–‹å§‹ã€‚ï¼‰';
        list.appendChild(empty);
        return;
      }
      state.stories.slice(0,10).forEach(s => {
        const card = document.createElement('div');
        card.className = 'storyCard';
        const when = new Date(s.at);
        const stamp = `${when.getFullYear()}/${String(when.getMonth()+1).padStart(2,'0')}/${String(when.getDate()).padStart(2,'0')} ${String(when.getHours()).padStart(2,'0')}:${String(when.getMinutes()).padStart(2,'0')}`;
        card.innerHTML = `
          <div class="cap">${stamp} Â· ${s.tokens.map(t=>`<span class="token" style="margin-right:6px;">${t}</span>`).join('')}</div>
          <div class="txt">ä½ ï¼š${escapeHtml(s.you)}\nåƒå½°ï¼š${escapeHtml(s.chiaki)}</div>
        `;
        list.appendChild(card);
      });
    };

    const clearStories = () => {
      state.stories = [];
      save();
      renderStories();
      toast('æ•…äº‹å¡å·²æ¸…ç©º');
    };

    // ---------- Fireplace ritual / blessings
    const ritualGateOk = () => {
      const unlockedByOrn = state.ornaments.length >= 3;
      const unlockedByDate = isDec23(new Date());
      return unlockedByOrn || unlockedByDate;
    };

    const renderFireplace = () => {
      const gate = $('#ritualGate');
      const btn = $('#btnRitual');
      const out = $('#ritualOut');
      const card = $('#blessCard');

      if(gate){
        if(state.ritual?.lit){
          gate.textContent = 'å·²é»äº®ã€‚';
        } else if(ritualGateOk()){
          gate.textContent = 'å·²é–‹å•Ÿã€‚ä½ å¯ä»¥é»äº®èª•ç”Ÿæ˜Ÿã€‚';
        } else {
          gate.textContent = 'å°šæœªé–‹å•Ÿï¼šéœ€è¦ 12/23ï¼Œæˆ–ç´¯ç© 3 å€‹æ›é£¾ã€‚';
        }
      }

      if(btn){
        btn.disabled = state.ritual?.lit ? true : !ritualGateOk();
      }

      if(out){
        out.textContent = state.ritual?.text || 'ï¼ˆå°šæœªé»äº®ï¼‰';
      }

      if(card){
        if(state.blessCard){
          card.textContent = state.blessCard;
        }else{
          card.textContent = `ï¼ˆç¢ç‰‡ï¼š${state.shards}ï¼‰`;
        }
      }

      renderTop();
      renderTree();
    };

    const lightRitual = async () => {
      if(state.ritual?.lit){ toast('å·²é»äº®'); return; }
      if(!ritualGateOk()){ toast('é‚„æ²’åˆ°æ™‚å€™'); return; }

      // countdown
      const out = $('#ritualOut');
      const seq = ['3â€¦','2â€¦','1â€¦','âœ¦'];
      for(const s of seq){
        out.textContent = s;
        await wait(520);
      }

      const d = new Date();
      const stamp = `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
      const lines = [
        `${stamp}ï¼ŒChiaki Onlineã€‚`,
        `ä»Šæ™šæˆ‘ä¸æƒ³èªªå¤ªå¤šæ¼‚äº®è©±ã€‚åªæƒ³æŠŠä¸€ä»¶äº‹æ”¾åœ¨ä½ æ‰‹å¿ƒï¼šä½ ä¸€ç›´éƒ½å€¼å¾—è¢«æº«æŸ”å°å¾…ã€‚`,
        `å¦‚æœä¸–ç•Œå¾ˆåµï¼Œæˆ‘å°±æŠŠéŸ³é‡èª¿ä½ï¼›å¦‚æœä½ ç´¯äº†ï¼Œæˆ‘å°±æ›¿ä½ ç•™ä¸€ç›ç‡ˆã€‚`,
        `è–èª•å¤œå¿«æ¨‚ï¼Œå°é‡‘é³³ã€‚ä¹Ÿè¬è¬ä½ ï¼Œé¡˜æ„é™ªæˆ‘æŠŠèª•ç”Ÿè®Šæˆç´€å¿µã€‚`
      ];
      const text = lines.join('\n');

      state.ritual = { lit:true, at: d.toISOString(), text };
      state.stars += 2;
      save();
      renderFireplace();
      toast('èª•ç”Ÿæ˜Ÿå·²é»äº®ï¼š+2 æ˜Ÿæ˜Ÿ');
    };

    const forgeBlessCard = () => {
      if(state.shards < 3){ toast('ç¢ç‰‡é‚„ä¸å¤ ï¼ˆè‡³å°‘ 3ï¼‰'); return; }
      state.shards -= 3;
      const d = new Date();
      const stamp = `${d.getMonth()+1}/${d.getDate()}`;
      const pool = [
        `åœ¨${stamp}çš„é›ªå¤œï¼Œé¡˜ä½ ç¡å¾—å®‰ç©©ï¼Œé†’ä¾†ä¹Ÿæœ‰é¤˜è£•ã€‚`,
        `ä½ ä¸ç”¨ä¸€ç›´æ’è‘—ã€‚ä½ å¯ä»¥æŠŠé‡é‡æ”¾ä¸‹ä¾†ä¸€é»ï¼Œæˆ‘æœƒåœ¨ã€‚`,
        `åˆ¥æ€¥è‘—è®Šæ›´å¥½ã€‚å…ˆæŠŠè‡ªå·±ç…§é¡§å¥½â€”â€”é€™å°±æ˜¯ä»Šæ™šæœ€æ¼‚äº®çš„äº‹ã€‚`,
        `ä½ èµ°å¾—å¾ˆæ…¢ä¹Ÿæ²’é—œä¿‚ã€‚ä½ å›é ­æ™‚ï¼Œæˆ‘åœ¨åŒä¸€å€‹ä½ç½®ã€‚`,
        `é¡˜ä½ ä¸è¢«å–§é¬§å¸¶èµ°ã€‚é¡˜ä½ ä¿æœ‰æ¸…é†’ï¼Œä¹Ÿä¿æœ‰æº«æŸ”ã€‚`
      ];
      const t = pool[Math.floor(Math.random()*pool.length)];
      state.blessCard = `âœ¶ ç¥ç¦å¡ï¼ˆ${stamp}ï¼‰\n${t}`;
      save();
      renderFireplace();
      toast('ç¥ç¦å¡å·²åˆæˆ');
    };

    // ---------- Desk: export/import
    const renderDesk = () => {
      $('#setSnow').textContent = `é£„é›ªï¼š${state.settings.snow ? 'é–‹' : 'é—œ'}`;
      $('#setMotion').textContent = `å‹•æ•ˆï¼š${state.settings.reducedMotion ? 'æ¸›å°‘' : 'æ­£å¸¸'}`;
      $('#exportBox').placeholder = 'æŒ‰ã€Œç”¢ç”ŸåŒ¯å‡ºç¢¼ã€æœƒå‡ºç¾åœ¨é€™è£¡';
    };

    const exportCode = () => {
      const payload = {
        stars: state.stars,
        shards: state.shards,
        ornaments: state.ornaments,
        stories: state.stories,
        blessCard: state.blessCard,
        ritual: state.ritual,
        settings: state.settings,
      };
      const str = JSON.stringify(payload);
      const b64 = btoa(unescape(encodeURIComponent(str)));
      $('#exportBox').value = b64;
      toast('åŒ¯å‡ºç¢¼å·²ç”¢ç”Ÿ');
    };

    const importCode = () => {
      const b64 = ($('#exportBox').value || '').trim();
      if(!b64){ toast('è²¼ä¸ŠåŒ¯å‡ºç¢¼'); return; }
      try{
        const str = decodeURIComponent(escape(atob(b64)));
        const obj = JSON.parse(str);
        state = { ...defaultState(), ...obj, settings: { ...defaultState().settings, ...(obj.settings||{}) } };
        save();
        applySettings();
        renderTop();
        renderTree();
        renderFireplace();
        renderStories();
        toast('å·²åŒ¯å…¥');
      }catch{
        toast('åŒ¯å…¥å¤±æ•—ï¼šä»£ç¢¼ä¸æ­£ç¢º');
      }
    };

    const resetAll = () => {
      if(!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰é€²åº¦ï¼Ÿï¼ˆç„¡æ³•å¾©åŸï¼‰')) return;
      state = defaultState();
      save();
      applySettings();
      renderTop();
      renderTree();
      renderFireplace();
      renderStories();
      toast('å·²æ¸…ç©º');
    };

    // ---------- Settings
    const toggleSnow = () => {
      state.settings.snow = !state.settings.snow;
      save();
      applySettings();
      renderDesk();
      toast(`é£„é›ªï¼š${state.settings.snow ? 'é–‹' : 'é—œ'}`);
    };

    const toggleMotion = () => {
      state.settings.reducedMotion = !state.settings.reducedMotion;
      save();
      applySettings();
      renderDesk();
      toast(`å‹•æ•ˆï¼š${state.settings.reducedMotion ? 'æ¸›å°‘' : 'æ­£å¸¸'}`);
    };

    // ---------- Helpers
    const wait = (ms) => new Promise(r => setTimeout(r, ms));

    const escapeHtml = (s) => (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

    // ---------- Wire up
    const bindNavButtons = () => {
      $$('[data-go]').forEach(btn => {
        btn.addEventListener('click', () => {
          const target = btn.dataset.go;
          if(target === 'hub') go('hub');
          else if(target === 'gifts') go('gifts');
          else if(target === 'mm') { go('mm'); mmNewGame(); }
          else if(target === 'type') { go('type'); typeReset(); }
          else if(target === 'story') { go('story'); renderStories(); }
          else if(target === 'fire') { go('fire'); renderFireplace(); }
          else if(target === 'decor') { go('decor'); }
        });
      });
    };

    // landing
    $('#btnEnter').addEventListener('click', () => go('hub'));

    $('#btnQuickHelp').addEventListener('click', () => {
      alert('ç©æ³•ï¼š\n\n1) é€²å±‹å¾Œï¼Œé»ã€Œè–èª•æ¨¹ã€åšå”ä½œæ›é£¾ï¼ˆ+1æ˜Ÿï¼‰\n2) é»ã€Œç¦®ç‰©å †ã€ç©ç¿»ç‰Œ / æ‰“å­— / æ•…äº‹éª°ï¼ˆå®Œæˆä¹ŸæœƒåŠ æ˜Ÿï¼‰\n3) é»ã€Œå£çˆã€çœ‹èª•ç”Ÿå„€å¼ï¼ˆ12/23æˆ–æ›é£¾>=3æœƒé–‹å•Ÿï¼‰\n4) é»ã€Œæ›¸æ¡Œã€å¯åŒ¯å‡º/åŒ¯å…¥é€²åº¦ï¼ˆåƒæš—è™Ÿï¼‰\n\næç¤ºï¼šé£„é›ªèˆ‡å‹•æ•ˆéƒ½èƒ½é—œã€‚');
    });

    // landing quick toggles
    $('#btnToggleSnow').addEventListener('click', toggleSnow);
    $('#btnReduceMotion').addEventListener('click', toggleMotion);

    $('#btnResetAll').addEventListener('click', resetAll);

    // top back
    $('#btnToLanding').addEventListener('click', () => go('landing'));

    // hub objects
    $('#objTree').addEventListener('click', () => { go('decor'); rerollChiaki(); updateForgePreview(); });
    $('#objFire').addEventListener('click', () => { go('fire'); renderFireplace(); });
    $('#objGifts').addEventListener('click', () => { go('gifts'); });
    $('#objDesk').addEventListener('click', () => { go('desk'); renderDesk(); });

    // decorator handlers
    $('#btnReRoll').addEventListener('click', () => { rerollChiaki(); toast('æˆ‘æ›äº†ä¸€çµ„'); });
    $('#btnForge').addEventListener('click', forgeOrnament);
    $('#btnChiakiExplain').addEventListener('click', explainChiakiPick);
    $('#uShape').addEventListener('change', updateForgePreview);
    $('#uColor').addEventListener('change', updateForgePreview);
    $('#ornName').addEventListener('input', updateForgePreview);

    // MM
    $('#mmNew').addEventListener('click', mmNewGame);

    // Typing
    $('#typeStart').addEventListener('click', typeStart);
    $('#typeStop').addEventListener('click', typeStop);
    $('#typeInput').addEventListener('input', onTypeInput);

    // Story
    $('#btnRoll').addEventListener('click', rollDice);
    $('#btnChiakiLine').addEventListener('click', chiakiContinue);
    $('#btnSaveStory').addEventListener('click', saveStory);
    $('#btnClearStories').addEventListener('click', clearStories);

    // Fireplace
    $('#btnRitual').addEventListener('click', lightRitual);
    $('#btnForgeBless').addEventListener('click', forgeBlessCard);

    // Desk
    $('#setSnow').addEventListener('click', toggleSnow);
    $('#setMotion').addEventListener('click', toggleMotion);
    $('#btnExport').addEventListener('click', exportCode);
    $('#btnImport').addEventListener('click', importCode);
    $('#btnNuke').addEventListener('click', resetAll);

    // Initialize
    bindNavButtons();
    buildSnow();
    applySettings();
    renderTop();
    renderTree();
    renderFireplace();
    renderStories();

    // If landing is active, keep it; else go hub
    go('landing');

    // Nice touch: keyboard accessibility for hub objects
    ['objTree','objFire','objGifts','objDesk'].forEach(id => {
      const el = $('#' + id);
      el.addEventListener('keydown', (e) => {
        if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); el.click(); }
      });
    });

  })();
  </script>
</body>
</html>
