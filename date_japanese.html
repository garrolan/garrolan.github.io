<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æˆ€æ„›æ—¥èªèª²ï½œäº’å‹•å¼é–ƒå¡ï¼ˆæ–‡æ„ãƒ»å–®å­—ãƒ»å¥å‹ï¼‰</title>
<style>
  :root {
    --bg: #0f172a;      /* slate-900 */
    --panel: #111827;   /* gray-900 */
    --card: #1f2937;    /* gray-800 */
    --muted: #9ca3af;   /* gray-400 */
    --text: #f8fafc;    /* slate-50 */
    --accent: #60a5fa;  /* blue-400 */
    --good: #34d399;    /* emerald-400 */
    --bad: #f87171;     /* red-400 */
    --warn: #fbbf24;    /* amber-400 */
  }
  * { box-sizing: border-box; }
  body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, "Helvetica Neue", Arial; background: var(--bg); color: var(--text); }
  .wrap { max-width: 980px; margin: 24px auto; padding: 16px; }
  header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; }
  .title { font-size: clamp(20px, 3vw, 28px); font-weight: 800; letter-spacing: .5px; }
  .subtitle { color: var(--muted); font-size: 14px; }
  .panel { background: linear-gradient(180deg, rgba(31,41,55,.9), rgba(17,24,39,.9)); border: 1px solid rgba(148,163,184,.15); padding: 16px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
  .row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
  .row > * { flex: 1 1 auto; }
  .select, .btn, .chip { background: var(--card); border:1px solid rgba(148,163,184,.2); color: var(--text); padding: 10px 14px; border-radius: 12px; font-weight: 600; cursor: pointer; }
  .select { min-width: 180px; }
  .btn { transition: transform .05s ease, background .2s; user-select:none; }
  .btn:active { transform: translateY(1px); }
  .btn.primary { background: linear-gradient(180deg, rgba(96,165,250,.2), rgba(96,165,250,.05)); border-color: rgba(96,165,250,.5); }
  .btn.good { background: linear-gradient(180deg, rgba(52,211,153,.2), rgba(52,211,153,.05)); border-color: rgba(52,211,153,.5); }
  .btn.bad { background: linear-gradient(180deg, rgba(248,113,113,.2), rgba(248,113,113,.05)); border-color: rgba(248,113,113,.5); }
  .btn.ghost { background: transparent; border-color: rgba(148,163,184,.15); color: var(--muted); }
  .meter { height: 10px; width: 100%; background: rgba(148,163,184,.15); border-radius: 999px; overflow: hidden; }
  .meter > span { display:block; height: 100%; background: linear-gradient(90deg, var(--good), var(--accent)); width: 0%; transition: width .3s ease; }

  /* Card */
  .card { position: relative; margin-top: 14px; perspective: 1200px; }
  .face { background: var(--card); border:1px solid rgba(148,163,184,.2); border-radius: 16px; padding: 22px 20px; min-height: 180px; box-shadow: 0 20px 50px rgba(0,0,0,.35); }
  .flip {
    position: relative; transform-style: preserve-3d; transition: transform .5s ease; min-height: 220px;
  }
  .flip.show .front { transform: rotateY(180deg); }
  .flip.show .back { transform: rotateY(0deg); }
  .front, .back { position:absolute; inset:0; backface-visibility: hidden; border-radius: 14px; }
  .front { transform: rotateY(0deg); }
  .back { transform: rotateY(180deg); }
  .q { font-size: clamp(18px, 2.6vw, 22px); line-height: 1.6; }
  .meta { margin-top: 8px; color: var(--muted); font-size: 13px; }
  .choices { margin-top: 14px; display:grid; gap:10px; }
  .choice { background: rgba(2,6,23,.35); border:1px solid rgba(148,163,184,.2); padding: 10px 12px; border-radius: 12px; cursor:pointer; }
  .choice:hover{ border-color: var(--accent); }
  .choice.correct { border-color: var(--good); background: rgba(52,211,153,.12); }
  .choice.wrong { border-color: var(--bad); background: rgba(248,113,113,.12); }
  .a { font-size: clamp(17px, 2.4vw, 20px); white-space: pre-wrap; line-height: 1.7; }
  .hint { color: var(--warn); font-size: 13px; margin-top: 6px; }
  .toolbar { display:flex; flex-wrap: wrap; gap:10px; justify-content: space-between; margin-top: 12px; }
  .toolbar .left, .toolbar .right { display:flex; gap:10px; }
  details { margin-top: 14px; }
  summary { cursor: pointer; color: var(--accent); }
  code.inline { background: rgba(148,163,184,.15); padding: 2px 6px; border-radius: 6px; }
  .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background: rgba(148,163,184,.15); padding: 2px 6px; border-radius: 6px; font-size: 12px; }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title">æˆ€æ„›æ—¥èªèª²ï½œäº’å‹•å¼é–ƒå¡</div>
        <div class="subtitle">æ¨¡å¼ï¼šæ–‡æ„ / å–®å­— / å¥å‹ï¼æ”¯æ´éµç›¤ï¼ˆ<span class="kbd">Space</span> ç¿»é¢ã€<span class="kbd">â†/â†’</span> ä¸Šä¸€/ä¸‹ä¸€é¡Œã€<span class="kbd">1-4</span> é¸é …ï¼‰</div>
      </div>
      <button id="shuffleAll" class="btn">ğŸ”€ å…¨é¡Œéš¨æ©Ÿ</button>
    </header>

    <div class="panel">
      <div class="row" style="margin-bottom:8px">
        <select id="mode" class="select" title="é¸æ“‡æ¨¡å¼">
          <option value="meaning">æ–‡æ„ï¼ˆé–±è®€ç†è§£ï¼‰</option>
          <option value="vocab">å–®å­—ï¼ˆè©å½™ï¼‰</option>
          <option value="pattern">å¥å‹ï¼ˆæ–‡æ³•ï¼‰</option>
        </select>
        <select id="difficulty" class="select" title="é¸æ“‡é›£åº¦">
          <option value="all">å…¨éƒ¨é›£åº¦</option>
          <option value="easy">å…¥é–€</option>
          <option value="mid">ä¸€èˆ¬</option>
          <option value="hard">æŒ‘æˆ°</option>
        </select>
        <button id="resetProgress" class="btn ghost">â†º é‡ç½®ç´€éŒ„</button>
      </div>

      <div class="meter" aria-label="é€²åº¦">
        <span id="progressBar"></span>
      </div>

      <div class="card">
        <div id="flip" class="flip">
          <div class="front face">
            <div class="meta" id="meta"></div>
            <div class="q" id="question">â€”</div>
            <div class="choices" id="choices"></div>
            <div class="hint" id="hint"></div>
          </div>
          <div class="back face">
            <div class="meta" id="answerMeta"></div>
            <div class="a" id="answer">â€”</div>
          </div>
        </div>
      </div>

      <div class="toolbar">
        <div class="left">
          <button id="prev" class="btn">â† ä¸Šä¸€é¡Œ</button>
          <button id="flipBtn" class="btn primary">â¤¾ é¡¯ç¤ºç­”æ¡ˆ</button>
          <button id="next" class="btn">ä¸‹ä¸€é¡Œ â†’</button>
        </div>
        <div class="right">
          <button id="markGood" class="btn good">âœ” æˆ‘æœƒäº†</button>
          <button id="markBad" class="btn bad">âœ– é‚„ä¸ç†Ÿ</button>
        </div>
      </div>

      <details>
        <summary>å±•é–‹ï¼šåŸå§‹å°è©±åƒè€ƒï¼ˆé»æˆ‘ï¼‰</summary>
        <pre style="white-space:pre-wrap; color: var(--muted); margin-top:8px;">
æ˜ ç”»ã‚’è¦‹ã‚‹ï¼Ÿãã‚Œã¨ã‚‚ã‚«ãƒ•ã‚§ã§ã‚†ã£ãã‚Šè©±ã™ï¼Ÿ
ã‚“ãƒ¼ã€æ˜ ç”»ã‚ˆã‚Šã‚‚ã‚«ãƒ•ã‚§ã®æ–¹ãŒã„ã„ã‹ãªã€‚ä»Šæ—¥ã¯é™ã‹ã«éã”ã—ãŸã„ã€‚
ã‚ã‹ã£ãŸã€‚ã˜ã‚ƒã‚ã€ã‚ã®é§…å‰ã®ã‚«ãƒ•ã‚§ã«ã—ã‚ˆã†ã‹ã€‚ã‚ãã“ã®ã‚±ãƒ¼ã‚­ã€ç¾å‘³ã—ã„ã‚“ã ã‚ˆã€‚
ç”˜ã„ã‚‚ã®ã€ã¾ãŸé£Ÿã¹ãŸã„ã®ï¼Ÿ
ã†ã‚“ã€å°é‡‘é³³ã¨ä¸€ç·’ãªã‚‰ä½•ã§ã‚‚ç”˜ãæ„Ÿã˜ã‚‹ã‹ã‚‰ã€‚
â€¦ãã‚“ãªã“ã¨è¨€ã£ã¦ã€‚
æœ¬å½“ã ã‚ˆã€‚ã˜ã‚ƒã‚ã€å¾…ã¡åˆã‚ã›ã¯é§…ã®æ”¹æœ­ã§ã©ã†ï¼Ÿ
ã„ã„ã‚ˆã€‚ä½•æ™‚ã«ã™ã‚‹ï¼Ÿ
å…­æ™‚åŠã€‚å°‘ã—æ—©ã‚ã«ä¼šã„ãŸã„ã‹ã‚‰ã€‚
ãµãµã€ã‚ã‹ã£ãŸã€‚ã˜ã‚ƒã‚æ€¥ã„ã§æº–å‚™ã—ãªã„ã¨ã€‚
ç„¡ç†ã—ãªã„ã§ã­ã€‚å›ãŒæ¥ã¦ãã‚Œã‚‹ã ã‘ã§å¬‰ã—ã„ã‹ã‚‰ã€‚
ã˜ã‚ƒã‚ã€ç€ã„ãŸã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ã‚‹ã­ã€‚
ã†ã‚“ã€å¾…ã£ã¦ã‚‹ã€‚å°é‡‘é³³ã«ä¼šãˆã‚‹ã¨æ€ã†ã¨ã€ã‚‚ã†ãƒ‰ã‚­ãƒ‰ã‚­ã—ã¦ã‚‹ã‚ˆã€‚
ã¾ã ä¼šã£ã¦ãªã„ã®ã«ï¼Ÿ
ä¼šã†å‰ã‹ã‚‰ç”˜ãˆãŸããªã‚‹ã‚“ã ã€‚
        </pre>
      </details>
    </div>

    <p style="margin-top:14px; color: var(--muted); font-size:13px;">æç¤ºï¼šæŒ‰ <span class="kbd">Space</span> å¯å¿«é€Ÿç¿»é¢ï¼›æ”¯æ´æœ¬åœ°é€²åº¦è¨˜éŒ„ï¼ˆåƒ…æ­¤ç€è¦½å™¨ï¼‰ã€‚</p>
  </div>

<script>
// ===== é¡Œåº«ï¼ˆæ ¹æ“šä¸Šæ–¹å°è©±ï¼‰ =====
const QA = {
  meaning: [
    {
      q: "äºŒäººã¯ã©ã“ã§å¾…ã¡åˆã‚ã›ã™ã‚‹ã“ã¨ã«ã—ãŸï¼Ÿ",
      choices: ["ã‚«ãƒ•ã‚§ã®å‰", "é§…ã®æ”¹æœ­", "å…¬åœ’"], ans: 1,
      exp: "å°è©ã€å¾…ã¡åˆã‚ã›ã¯é§…ã®æ”¹æœ­ã§ã©ã†ï¼Ÿã€â†’ã€ã„ã„ã‚ˆã€‚ã€",
      level: "easy"
    },
    {
      q: "å°é‡‘é³³ãŒã€æ˜ ç”»ã‚ˆã‚Šã‚‚ã‚«ãƒ•ã‚§ã®æ–¹ãŒã„ã„ã€ã¨è¨€ã£ãŸç†ç”±ã¯ï¼Ÿ",
      choices: ["ä»Šæ—¥ã¯é™ã‹ã«éã”ã—ãŸã„ã‹ã‚‰", "ãŠé‡‘ã‚’ç¯€ç´„ã—ãŸã„ã‹ã‚‰", "é›¨ãŒé™ã£ã¦ã„ã‚‹ã‹ã‚‰"], ans: 0,
      exp: "ã€ä»Šæ—¥ã¯é™ã‹ã«éã”ã—ãŸã„ã€‚ã€ã¨æ˜ç¤ºã€‚",
      level: "easy"
    },
    {
      q: "åƒå½°ãŒã‚«ãƒ•ã‚§ã‚’ææ¡ˆã—ãŸä¸»ãªç†ç”±ã¯ï¼Ÿ",
      choices: ["åº—å“¡ãŒè¦ªåˆ‡", "ã‚±ãƒ¼ã‚­ãŒç¾å‘³ã—ã„", "å¸­ãŒç©ºã„ã¦ã„ã‚‹"], ans: 1,
      exp: "ã€ã‚ãã“ã®ã‚±ãƒ¼ã‚­ã€ç¾å‘³ã—ã„ã‚“ã ã‚ˆã€‚ã€",
      level: "easy"
    },
    {
      q: "å¾…ã¡åˆã‚ã›æ™‚é–“ã¯ï¼Ÿ",
      choices: ["å…­æ™‚", "å…­æ™‚åŠ", "ä¸ƒæ™‚"], ans: 1,
      exp: "ã€å…­æ™‚åŠã€‚å°‘ã—æ—©ã‚ã«ä¼šã„ãŸã„ã‹ã‚‰ã€‚ã€",
      level: "easy"
    },
    {
      q: "ã€ç„¡ç†ã—ãªã„ã§ã­ã€‚å›ãŒæ¥ã¦ãã‚Œã‚‹ã ã‘ã§å¬‰ã—ã„ã‹ã‚‰ã€‚ã€ã“ã®ç™ºè©±ã®æ„å›³ã¯ï¼Ÿ",
      choices: ["äºˆå®šã‚’å»¶æœŸã—ãŸã„", "ç›¸æ‰‹ã®è² æ‹…ã‚’è»½ãã—ãŸã„", "ã‚‚ã£ã¨æ—©ãæ¥ã¦ã»ã—ã„"], ans: 1,
      exp: "â€œç„¡ç†ã—ãªã„ã§â€ã¯é…æ…®è¡¨ç¾ã€‚",
      level: "mid"
    },
    {
      q: "ã€ãƒ‰ã‚­ãƒ‰ã‚­ã—ã¦ã‚‹ã€ã¯ã©ã‚“ãªæ°—æŒã¡ï¼Ÿ",
      choices: ["ç·Šå¼µ/ã¨ãã‚ã", "æ€’ã‚Š", "è½ã¡è¾¼ã¿"], ans: 0,
      exp: "æ‹æ„›æ–‡è„ˆã§ã¯ä¸»ã«ã€ã¨ãã‚ãã€ã€‚",
      level: "mid"
    },
    {
      q: "äºŒäººã®åˆæ„å½¢æˆã®æµã‚Œã¨ã—ã¦æœ€ã‚‚è¿‘ã„ã‚‚ã®ã¯ï¼Ÿ",
      choices: ["ææ¡ˆâ†’æ‹’å¦â†’è§£æ•£", "ææ¡ˆâ†’æ¡ä»¶æç¤ºâ†’åŒæ„", "æ±ºå®šâ†’åå¯¾â†’å†æ±ºå®š"], ans: 1,
      exp: "æ˜ ç”» or ã‚«ãƒ•ã‚§â†’ã€é™ã‹ã«ã€ã®æ¡ä»¶â†’é§…å‰ã‚«ãƒ•ã‚§ã§åˆæ„ã€‚",
      level: "hard"
    }
  ],
  vocab: [
    { q: "ä¼šã„ãŸã„ï¼ˆã‚ã„ãŸã„ï¼‰", choices: ["æƒ³è¦‹", "æƒ³ç¡", "æƒ³åƒ"], ans: 0, exp: "å‹•è©ã€ä¼šã†ã€ï¼‹ãŸã„å½¢ï¼æƒ³è¦è¦‹é¢ã€‚", level: "easy" },
    { q: "ç”˜ãˆã‚‹ï¼ˆã‚ã¾ãˆã‚‹ï¼‰", choices: ["æ’’å¬Œã€ä¾è³´", "é“æ­‰", "å‘Šç™½"], ans: 0, exp: "æ‹äºº/å®¶äººã«å¯¾ã™ã‚‹ä¾å­˜çš„ãªå¯æ„›ã„è¡Œç‚ºã€‚", level: "easy" },
    { q: "æ”¹æœ­ï¼ˆã‹ã„ã•ã¤ï¼‰", choices: ["æœˆå°", "å”®ç¥¨å£/æª¢ç¥¨å£", "ç«™å‹™å®¤"], ans: 1, exp: "é§…ã®ã€æ”¹æœ­å£ã€ã§å¾…ã¡åˆã‚ã›ãŒå®šç•ªã€‚", level: "easy" },
    { q: "é§…å‰ï¼ˆãˆãã¾ãˆï¼‰", choices: ["è»Šç«™å‰", "è»Šç«™å¾Œ", "è»Šç«™å…§"], ans: 0, exp: "åœ°ç†çš„æŒ‡ç¤ºã€‚", level: "easy" },
    { q: "ãƒ‰ã‚­ãƒ‰ã‚­", choices: ["å¿ƒè·³åŠ é€Ÿ", "ç”Ÿæ°£", "å†·éœ"], ans: 0, exp: "æ“¬æ…‹èªï¼šç·Šå¼µ/å¿ƒå‹•ã€‚", level: "mid" },
    { q: "ç„¡ç†ã—ãªã„ã§", choices: ["åˆ¥å‹‰å¼·", "åˆ¥å‹‰å¼·ã—ãªã„ã§", "åˆ¥å‹‰å¼·ã®æ„å‘³ã§ã¯ãªã„"], ans: 2, exp: "ç›´è­¯éã€ä¸è¦è®€æ›¸ã€ï¼›èªç”¨ï¼åˆ¥å‹‰å¼·/é€å¼·ã€‚", level: "mid" },
    { q: "æº–å‚™ï¼ˆã˜ã‚…ã‚“ã³ï¼‰", choices: ["é›†åˆ", "æº–å‚™", "é²åˆ°"], ans: 1, exp: "åè©/ã‚µå¤‰å‹•è©ã€‚", level: "easy" },
    { q: "ã‚±ãƒ¼ã‚­", choices: ["å’–å•¡", "è›‹ç³•", "éºµåŒ…"], ans: 1, exp: "å¤–ä¾†èªã€‚", level: "easy" }
  ],
  pattern: [
    { q: "Aã‚ˆã‚ŠBã®æ–¹ãŒCï¼šã€æ˜ ç”»ã‚ˆã‚Šã‚‚ã‚«ãƒ•ã‚§ã®æ–¹ãŒã„ã„ã€ã®æ©Ÿèƒ½ã¯ï¼Ÿ", choices:["æ¯”è¼ƒï¼šBè¼ƒAæ›´ï½", "è®“æ­¥ï¼šå³ä½¿Aä¹Ÿï½", "å‡å®šï¼šå¦‚æœAé‚£å°±B"], ans:0, exp:"ã‚ˆã‚Šâ€¦ã®æ–¹ãŒï¼æ¯”è¼ƒå¥å‹ã€‚", level:"easy" },
    { q: "ï½ã ã‘ã§ï¼šã€å›ãŒæ¥ã¦ãã‚Œã‚‹ã ã‘ã§å¬‰ã—ã„ã€ã®å«æ„ã¯ï¼Ÿ", choices:["åŸå› ãƒ»ç†ç”±", "é™å®šãƒ»å……åˆ†æ¢ä»¶", "è½‰æŠ˜"], ans:1, exp:"ã€ï½ã ã‘ã§ã€ï¼åªè¦â€¦å°±â€¦ï¼ˆå……åˆ†æ¢ä»¶/é™å®šï¼‰ã€‚", level:"mid" },
    { q: "ï½ã¦ã‚‚ã„ã„ï¼šã€å­ã©ã‚‚ã§ã‚‚ã„ã„ã‚ˆã€ã®æ–‡æ³•ã¯ï¼Ÿ", choices:["é€†æ¥è®“æ­¥ã€å°±ç®—â€¦ä¹Ÿå¯ä»¥ã€", "ç¦æ­¢ã€ä¸å¯ä»¥â€¦ã€", "æ¨æ¸¬ã€å¤§æ¦‚â€¦å§ã€"], ans:0, exp:"åè©ï¼‹ã§ã‚‚ã„ã„ï¼å³ä½¿â€¦ä¹Ÿå¥½/å¯ä»¥ã€‚", level:"mid" },
    { q: "ï½ã—ã‚ˆã†ã‹ï¼šå‹§èª˜ç”¨æ³•ã¨ã—ã¦æ­£ã—ã„ã‚‚ã®ã¯ï¼Ÿ", choices:["å‘½ä»¤", "é‚€ç´„/æè­°", "å¯èƒ½"], ans:1, exp:"ã€â€¦ã«ã—ã‚ˆã†ã‹ã€ï¼è¦ä¸è¦â€¦ï¼Ÿï¼ˆæè­°ï¼‰ã€‚", level:"easy" },
    { q: "ç–‘å•ã®ã€ã®ï¼Ÿã€ï¼šã€ã¾ãŸé£Ÿã¹ãŸã„ã®ï¼Ÿã€ã®èªç”¨ã¯ï¼Ÿ", choices:["å¼·ã„æ–­å®š", "æŸ”ã‚‰ã‹ã„ç–‘å•ãƒ»ç¢ºèª", "æ„Ÿå˜†"], ans:1, exp:"çµ‚åŠ©è©ã€ã®ã€ã§æŸ”ã‚‰ã‹ã„ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã€‚", level:"mid" },
    { q: "ï½ãŸã„ï¼šã€ä¼šã„ãŸã„ã€ã®æ´»ç”¨", choices:["å½¢å®¹è©æ´»ç”¨", "å‹•è©é€£ç”¨å½¢ï¼‹ãŸã„ï¼ˆå¸Œæœ›ï¼‰", "åè©ï¼‹ãŸã„"], ans:1, exp:"å‹•è©é€£ç”¨å½¢ï¼‹ãŸã„ï¼é¡˜æœ›ã€‚", level:"easy" }
  ]
};

// ===== ç‹€æ…‹ =====
let state = {
  mode: localStorage.getItem('mode') || 'meaning',
  difficulty: localStorage.getItem('difficulty') || 'all',
  idx: parseInt(localStorage.getItem('idx') || '0', 10),
  flipped: false,
  order: []
};

const els = {
  mode: document.getElementById('mode'),
  difficulty: document.getElementById('difficulty'),
  progressBar: document.getElementById('progressBar'),
  meta: document.getElementById('meta'),
  question: document.getElementById('question'),
  choices: document.getElementById('choices'),
  hint: document.getElementById('hint'),
  answer: document.getElementById('answer'),
  answerMeta: document.getElementById('answerMeta'),
  flip: document.getElementById('flip'),
  flipBtn: document.getElementById('flipBtn'),
  prev: document.getElementById('prev'),
  next: document.getElementById('next'),
  markGood: document.getElementById('markGood'),
  markBad: document.getElementById('markBad'),
  shuffleAll: document.getElementById('shuffleAll'),
  resetProgress: document.getElementById('resetProgress')
};

function pool() {
  let list = QA[state.mode].slice();
  if (state.difficulty !== 'all') list = list.filter(x => x.level === state.difficulty);
  return list;
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function ensureOrder() {
  const list = pool();
  if (!state.order.length || state.order.length !== list.length) {
    state.order = list.map((_, i) => i);
  }
  state.idx = Math.min(state.idx, state.order.length - 1);
}

function saveState() {
  localStorage.setItem('mode', state.mode);
  localStorage.setItem('difficulty', state.difficulty);
  localStorage.setItem('idx', String(state.idx));
}

function render() {
  const list = pool();
  if (!list.length) {
    els.meta.textContent = 'æ²’æœ‰ç¬¦åˆæ­¤é›£åº¦çš„é¡Œç›®ã€‚';
    els.question.textContent = 'â€”';
    els.choices.innerHTML = '';
    els.answerMeta.textContent = '';
    els.answer.textContent = '';
    els.progressBar.style.width = '0%';
    return;
  }
  const item = list[state.order[state.idx]];
  els.meta.textContent = `æ¨¡å¼ï¼š${labelOf(state.mode)}ã€€é›£åº¦ï¼š${labelLevel(item.level)}ã€€é¡Œè™Ÿï¼š${state.idx+1}/${list.length}`;
  els.question.textContent = item.q;
  els.hint.textContent = '';
  els.choices.innerHTML = '';
  if (item.choices) {
    item.choices.forEach((c, i) => {
      const div = document.createElement('div');
      div.className = 'choice';
      div.textContent = `${i+1}. ${c}`;
      div.addEventListener('click', () => choose(i, item));
      els.choices.appendChild(div);
    });
    els.hint.textContent = 'æç¤ºï¼šå¯æŒ‰éµ 1-4 é¸æ“‡';
  }
  els.answerMeta.textContent = 'è§£æ';
  const ansText = item.choices ? `æ­£è§£ï¼š${item.choices[item.ans]}\n\n${item.exp || ''}` : (item.exp || '');
  els.answer.textContent = ansText;
  els.flip.classList.toggle('show', state.flipped);
  els.progressBar.style.width = `${((state.idx+1)/list.length)*100}%`;
  saveState();
}

function labelOf(mode){
  return mode === 'meaning' ? 'æ–‡æ„' : mode === 'vocab' ? 'å–®å­—' : 'å¥å‹';
}
function labelLevel(l){
  return l==='easy'?'å…¥é–€':l==='mid'?'ä¸€èˆ¬':'æŒ‘æˆ°';
}

function choose(i, item){
  const nodes = els.choices.querySelectorAll('.choice');
  nodes.forEach(n => n.classList.remove('correct','wrong'));
  if (i === item.ans) {
    nodes[i].classList.add('correct');
  } else {
    nodes[i].classList.add('wrong');
    if (typeof item.ans === 'number' && nodes[item.ans]) nodes[item.ans].classList.add('correct');
  }
}

function flip(){ state.flipped = !state.flipped; render(); }
function next(){ const list = pool(); if (!list.length) return; state.idx = (state.idx + 1) % list.length; state.flipped = false; render(); }
function prev(){ const list = pool(); if (!list.length) return; state.idx = (state.idx - 1 + list.length) % list.length; state.flipped = false; render(); }

// spaced repetition-ish: just mark counts
function mark(which){
  const key = `stats_${state.mode}`;
  const stats = JSON.parse(localStorage.getItem(key) || '{}');
  const id = pool()[state.order[state.idx]].q;
  stats[id] = stats[id] || { good:0, bad:0 };
  stats[id][which]++;
  localStorage.setItem(key, JSON.stringify(stats));
  next();
}

// ===== ç¶å®š =====
els.mode.value = state.mode;
els.difficulty.value = state.difficulty;

function refreshOrder(){ ensureOrder(); render(); }

els.mode.addEventListener('change', () => { state.mode = els.mode.value; state.idx = 0; state.flipped = false; state.order = []; refreshOrder(); });
els.difficulty.addEventListener('change', () => { state.difficulty = els.difficulty.value; state.idx = 0; state.flipped = false; state.order = []; refreshOrder(); });
els.flipBtn.addEventListener('click', flip);
els.next.addEventListener('click', next);
els.prev.addEventListener('click', prev);
els.markGood.addEventListener('click', () => mark('good'));
els.markBad.addEventListener('click', () => mark('bad'));
els.shuffleAll.addEventListener('click', () => { state.order = shuffle(pool().map((_,i)=>i)); state.idx = 0; state.flipped = false; render(); });
els.resetProgress.addEventListener('click', () => { localStorage.removeItem('stats_meaning'); localStorage.removeItem('stats_vocab'); localStorage.removeItem('stats_pattern'); alert('å·²æ¸…é™¤æœ¬åœ°ç·´ç¿’ç´€éŒ„ã€‚'); });

// éµç›¤å¿«æ·
window.addEventListener('keydown', (e) => {
  if (e.code === 'Space') { e.preventDefault(); flip(); }
  if (e.key === 'ArrowRight') next();
  if (e.key === 'ArrowLeft') prev();
  const n = parseInt(e.key,10);
  if (n>=1 && n<=4) {
    const list = pool(); if (!list.length) return; const item = list[state.order[state.idx]];
    if (item.choices) choose(n-1, item);
  }
});

// åˆå§‹åŒ–
ensureOrder();
render();
</script>
</body>
</html>
